<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Integrative Touch Therapies - Premium holistic healing and wellness services. Experience transformative fascial release therapy in a luxury spa environment.">
    <meta name="keywords" content="luxury spa, fascial release therapy, holistic healing, wellness, premium massage, integrative bodywork">
    <meta name="author" content="Integrative Touch Therapies LLC">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com ; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com ; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://api.stripe.com; frame-src https://js.stripe.com; object-src 'none'; base-uri 'self'; frame-ancestors 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <title>Integrative Touch Therapies | Luxury Holistic Healing & Wellness</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ittheal.com/">
    <meta property="og:title" content="Integrative Touch Therapies | Luxury Holistic Healing & Wellness">
    <meta property="og:description" content="Premium holistic healing and wellness services. Experience transformative fascial release therapy in a luxury spa environment.">
    <meta property="og:image" content="https://ittheal.com/assets/logos/itt-heal-lotus-512.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://ittheal.com/">
    <meta property="twitter:title" content="Integrative Touch Therapies | Luxury Holistic Healing & Wellness">
    <meta property="twitter:description" content="Premium holistic healing and wellness services. Experience transformative fascial release therapy in a luxury spa environment.">
    <meta property="twitter:image" content="https://ittheal.com/assets/logos/itt-heal-lotus-512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/logos/itt-heal-lotus-32.png?v=20250710">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/logos/itt-heal-lotus-32.png?v=20250710">
    <link rel="icon" type="image/png" sizes="64x64" href="./assets/logos/itt-heal-lotus-64.png?v=20250710">
    <link rel="icon" type="image/png" sizes="128x128" href="./assets/logos/itt-heal-lotus-128.png?v=20250710">
    <link rel="icon" type="image/png" sizes="256x256" href="./assets/logos/itt-heal-lotus-256.png?v=20250710">
    <link rel="apple-touch-icon" href="./assets/logos/itt-heal-lotus-256.png?v=20250710">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json?v=20250708">
    
    <!-- Playfair Display Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS v4 -->
    <link rel="stylesheet" href="./dist/tailwind.css?v=20250712-august-update">
    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="./dist/luxury-spa.css?v=20250712-august-update">
    
    <!-- CLAUDE.md WCAG 2.1 AA Compliance Styles -->
    <style>
        /* CRITICAL: Header height override for all devices */
        .itt-header {
            height: 160px !important;
        }
        .itt-company-name {
            font-size: 1.5rem !important;
        }
        .itt-tagline {
            font-size: 1.5rem !important;
        }
        @media (max-width: 768px) {
            .itt-header {
                height: 160px !important;
            }
            .itt-company-name {
                font-size: 1.3rem !important;
            }
            .itt-tagline {
                font-size: 1.2rem !important;
            }
        }
        @media (max-width: 480px) {
            .itt-header {
                height: 160px !important;
            }
            .itt-company-name {
                font-size: 1.1rem !important;
            }
            .itt-tagline {
                font-size: 1rem !important;
            }
        }
        @media (max-width: 344px) {
            .itt-header {
                height: 160px !important;
            }
            .itt-company-name {
                font-size: 1rem !important;
            }
            .itt-tagline {
                font-size: 0.9rem !important;
            }
        }
        
        /* Focus indicators - 3px solid #ffd700 for all interactive elements */
        input:focus, select:focus, button:focus, a:focus {
            outline: 3px solid #ffd700 !important;
            outline-offset: 2px;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            #booking-date, #booking-time {
                border-color: #000 !important;
                background-color: #fff !important;
            }
            #date-availability-info {
                background-color: #000 !important;
                color: #fff !important;
                padding: 0.5rem;
                border: 2px solid #fff;
            }
            #closed-date-warning {
                background-color: #ff0000 !important;
                color: #fff !important;
            }
        }
        
        /* Touch target minimum size compliance */
        #booking-date, #booking-time {
            min-height: 44px !important;
            min-width: 44px !important;
        }
        
        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Enhanced keyboard navigation */
        #booking-date:focus-visible, #booking-time:focus-visible {
            box-shadow: 0 0 0 3px #ffd700;
        }
    </style>
    
    <!-- Custom theme configuration for reference -->
    <script>
      // Theme configuration moved to tailwind.config.js
      const themeColors = {
        'spa-cream': '#fdfcf7',
        'spa-sage-light': '#f0f4f0',
        'spa-sage-dark': '#6b7b6b',
        'spa-lavender-light': '#f5f3ff',
        'spa-ocean-light': '#e0f2fe',
        'spa-charcoal': '#2d3748',
      };
    </script>
    
    <!-- Luxury Spa CSS (loads AFTER Tailwind to override when needed) -->
    <!-- CSS already loaded above with updated cache-busting -->
    
    <!-- Stripe JavaScript SDK -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Force Cache Refresh -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-buster" content="20250625-header-fix">
    
</head>

<body>
<!-- Skip to main content link for accessibility -->
<a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-blue-600 focus:text-white focus:rounded">Skip to main content</a>

<!-- Hidden class safelist injection -->
<div class="hidden">text-green-700 font-serif italic text-lg text-center rounded-lg bg-gradient-to-br font-playfair</div>

<header class="itt-header" style="height: 160px !important;">
  <!-- Left Side - Logo (Leaf/Droplet) -->
  <div class="itt-header-logo">
    <img src="./assets/logos/itt-heal-lotus.png" alt="ITT Heal Logo" class="itt-logo-leaf" style="width: 60px; height: 60px;">
  </div>
  
  <!-- Center - Typography -->
  <div class="itt-header-center">
    <h1 class="itt-company-name" style="font-size: 1.5rem;">
      <div>Integrative Touch</div>
      <div>Therapies</div>
    </h1>
    <p class="itt-tagline" style="font-size: 1.5rem;">Holistic Healing &amp; Wellness</p>
  </div>
  
  <!-- Right Side - Hamburger Menu -->
  <div class="itt-header-menu">
    <button class="itt-hamburger" aria-label="Open navigation menu" id="hamburger-btn" aria-expanded="false" aria-controls="mobile-menu" onclick="var menu = document.getElementById('mobile-menu'); if (menu.style.display === 'block') { menu.style.display = 'none'; document.body.style.overflow = ''; } else { menu.style.display = 'block'; document.body.style.overflow = 'hidden'; }">
      <span class="itt-hamburger-line"></span>
      <span class="itt-hamburger-line"></span>
      <span class="itt-hamburger-line"></span>
    </button>
  </div>
</header>

<!-- Mobile Navigation Menu -->
<nav id="mobile-menu" class="itt-mobile-nav" style="display: none;" role="navigation" aria-label="Mobile navigation menu" aria-hidden="true">
    <div class="mobile-menu-content">
        <button class="close-menu" id="close-menu-btn" aria-label="Close navigation menu" onclick="document.getElementById('mobile-menu').style.display = 'none'; document.body.style.overflow = '';">
            <span style="font-size: 24px;" aria-hidden="true">✕</span>
        </button>
        <ul class="mobile-menu-list">
            <li><a href="#hero" class="mobile-menu-link" onclick="document.getElementById('mobile-menu').style.display = 'none'; document.body.style.overflow = '';">Home</a></li>
            <li><a href="#services" class="mobile-menu-link" onclick="document.getElementById('mobile-menu').style.display = 'none'; document.body.style.overflow = '';">Services</a></li>
            <li><a href="#about" class="mobile-menu-link" onclick="document.getElementById('mobile-menu').style.display = 'none'; document.body.style.overflow = '';">About Dr. Shiffer</a></li>
            <li><a href="#six-modalities" class="mobile-menu-link" onclick="document.getElementById('mobile-menu').style.display = 'none'; document.body.style.overflow = '';">What We Do</a></li>
            <li><a href="#pricing" class="mobile-menu-link" onclick="document.getElementById('mobile-menu').style.display = 'none'; document.body.style.overflow = '';">Pricing</a></li>
            <li><a href="#booking" class="mobile-menu-link" onclick="document.getElementById('mobile-menu').style.display = 'none'; document.body.style.overflow = '';">Book Session</a></li>
            <li><a href="#contact" class="mobile-menu-link" onclick="document.getElementById('mobile-menu').style.display = 'none'; document.body.style.overflow = '';">Contact</a></li>
        </ul>
    </div>
</nav>

    <!-- Main Content -->
    <main id="main-content" class="main-content">
        
        <!-- Hero Section -->
        <section id="hero" style="
            background: linear-gradient(180deg, var(--spa-lavender-light) 0%, var(--lavender-client) 30%, var(--warm-gray-100) 70%, rgba(245, 245, 245, 0.3) 100%); 
            min-height: 70vh; 
            padding-bottom: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        ">
            <div style="
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2rem 1rem;
                min-height: 70vh;
                width: 100%;
            ">
                <div style="
                    max-width: 64rem;
                    margin: 0 auto;
                    text-align: center;
                ">
                    <!-- Main Heading -->
                    <h2 class="font-playfair" style="
                        color: var(--spa-charcoal);
                        font-size: clamp(2rem, 5vw, 3.5rem);
                        font-weight: 400;
                        line-height: 1.2;
                        margin-bottom: 1.5rem;
                        text-align: center;
                    ">
                        Where Pain Ends and Healing Begins
                    </h2>
                    
                    <!-- Subtitle -->
                    <p class="font-playfair" style="
                        color: #15803d;
                        font-style: italic;
                        font-size: 1.5rem;
                        margin-bottom: 1.5rem;
                        text-align: center;
                    ">
                        Therapeutic Massage That Targets the Root Cause
                    </p>
                    
                    <!-- Subtext -->
                    <p class="font-playfair" style="
                        color: var(--spa-gray);
                        font-size: 1.1rem;
                        line-height: 1.6;
                        max-width: 42rem;
                        margin: 0 auto 2rem auto;
                        padding: 0 1rem;
                        text-align: center;
                    ">
                        Experience professional fascial release therapy designed to eliminate chronic pain and restore natural movement
                    </p>
                    
                    <!-- App-First CTA Strategy -->
                    <div style="padding-top: 1rem; display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                        <!-- Primary: App Download (Prominent) -->
                        <div style="background: linear-gradient(135deg, #059669, #065f46); padding: 1.5rem; border-radius: 1rem; text-align: center; box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3); max-width: 400px; width: 100%;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">📱</div>
                            <h3 style="color: white; font-size: 1.3rem; margin: 0 0 0.5rem 0; font-weight: 600;">Get the Full Healing Experience</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0 0 1rem 0;">AI pain tracking • Save $10 per session • Priority booking</p>
                            <button style="background: white; color: #059669; border: none; padding: 0.8rem 1.5rem; border-radius: 2rem; font-weight: 600; font-size: 1rem; cursor: pointer; width: 100%; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                📱 Download App - Coming Mid August
                            </button>
                        </div>
                        
                        <!-- Secondary: Web Booking (For Tech-Challenged) -->
                        <div style="text-align: center; max-width: 400px;">
                            <p style="color: var(--spa-gray); font-size: 0.9rem; margin: 0 0 0.5rem 0;">Need help with technology? We're here for you.</p>
                            <a href="#booking" style="
                                display: inline-block;
                                padding: 0.75rem 1.5rem;
                                font-family: 'Playfair Display', serif;
                                font-weight: 500;
                                font-size: 1rem;
                                color: var(--spa-charcoal);
                                background: var(--spa-cream);
                                border: 2px solid var(--spa-sage-light);
                                border-radius: 2rem;
                                text-decoration: none;
                                transition: all 0.3s ease;
                                cursor: pointer;
                                min-height: 44px;
                            ">Book on Web (Regular Pricing)</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Elegant CTA Transition Block -->
        <section class="text-center cta-transition-block" style="margin-top: -2rem; padding: 2.5rem 0; position: relative; z-index: 3;">
            <div class="mobile-container">
                <div class="animate-fade-in" style="opacity: 0; animation: fadeIn 1s ease-out 0.5s forwards;">
                    <p class="font-playfair text-lg" style="color: var(--spa-charcoal); font-size: 1.25rem; margin-bottom: 0.75rem;">
                        ✨ Ready to begin your healing journey?
                    </p>
                    <p class="font-playfair" style="color: var(--sage-600); font-size: 1rem;">
                        Explore our specialties below or book your first session
                    </p>
                </div>
            </div>
        </section>

        <!-- Premium Services Section -->
        <section id="services" class="luxury-section luxury-section-accent" style="padding-top: 1rem; margin-top: 0; position: relative; z-index: 2; background: linear-gradient(180deg, rgba(245, 245, 245, 0.1) 0%, var(--spa-sage-light) 30%, var(--spa-sage-light) 100%);">
            <div class="mobile-container">
                <!-- Section Header -->
                <div class="text-center mb-md" style="padding-top: 0.5rem;">
                    <h2 class="section-heading">What We Actually Help With</h2>
                    <p class="body-large" style="max-width: 300px; margin: 0 auto;">
                        Real solutions for real pain. No mystical promises—just proven techniques that work.
                    </p>
                </div>
                
                <!-- Service Cards -->
                <div class="services-grid">
                    <!-- Service 1: Neck & Shoulder Relief -->
                    <div class="luxury-card animate-fade-in animate-stagger-1">
                        <div class="flex flex-row flex-wrap items-start mb-lg">
                            <div class="benefit-icon mr-md">
                                <svg style="width: 1rem; height: 1rem; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm">Neck & Shoulder Relief</h3>
                                <p class="body-text mb-lg">
                                    That constant tension between your shoulders? The neck pain that won't quit? We fix it at the source.
                                </p>
                            </div>
                        </div>
                        
                        <!-- What We Treat -->
                        <div>
                            <h4 class="what-we-treat-heading">What We Treat:</h4>
                            <div class="space-y-sm">
                                <div class="benefit-item">
                                    <span class="luxury-symbol">◈</span>
                                    <span class="benefit-description">Tech neck & computer posture</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">◈</span>
                                    <span class="benefit-description">Tension headaches</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">◈</span>
                                    <span class="benefit-description">Frozen shoulder</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">◈</span>
                                    <span class="benefit-description">Chronic upper back tightness</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service 2: Back & Hip Freedom -->
                    <div class="luxury-card animate-fade-in animate-stagger-2">
                        <div class="flex flex-row flex-wrap items-start mb-lg">
                            <div class="benefit-icon mr-md" style="background: linear-gradient(135deg, var(--ocean-mist), var(--sage-400));">
                                <svg style="width: 1rem; height: 1rem; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm">Back & Hip Freedom</h3>
                                <p class="body-text mb-lg">
                                    Lower back pain, hip stiffness, sciatica? We'll get you moving freely again without the constant ache.
                                </p>
                            </div>
                        </div>
                        
                        <!-- What We Treat -->
                        <div>
                            <h4 class="what-we-treat-heading">What We Treat:</h4>
                            <div class="space-y-sm">
                                <div class="benefit-item">
                                    <span class="luxury-symbol">❋</span>
                                    <span class="benefit-description">Chronic lower back pain</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">❋</span>
                                    <span class="benefit-description">Hip flexor tightness</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">❋</span>
                                    <span class="benefit-description">Sciatica & leg pain</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">❋</span>
                                    <span class="benefit-description">Post-workout soreness</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service 3: Whole Body Reset -->
                    <div class="luxury-card animate-fade-in animate-stagger-3">
                        <div class="flex flex-row flex-wrap items-start mb-lg">
                            <div class="benefit-icon mr-md" style="background: linear-gradient(135deg, var(--sage-600), var(--sage-800));">
                                <svg style="width: 1rem; height: 1rem; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                </svg>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm">Whole Body Reset</h3>
                                <p class="body-text mb-lg">
                                    When everything hurts and nothing seems to help. Full-body integration for complex pain patterns.
                                </p>
                            </div>
                        </div>
                        
                        <!-- What We Treat -->
                        <div>
                            <h4 class="what-we-treat-heading">What We Treat:</h4>
                            <div class="space-y-sm">
                                <div class="benefit-item">
                                    <span class="luxury-symbol">✧</span>
                                    <span class="benefit-description">TMJ & jaw tension</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">✧</span>
                                    <span class="benefit-description">Fibromyalgia relief</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">✧</span>
                                    <span class="benefit-description">Stress-related pain</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="luxury-symbol">✧</span>
                                    <span class="benefit-description">Post-injury recovery</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- How We're Different - Luxury Treatment -->
                <div class="luxury-card-elevated animate-fade-in animate-stagger-4" style="margin-top: var(--space-3xl);">
                    <div class="text-center mb-xl">
                        <h3 class="section-heading">How We're Different</h3>
                    </div>
                    
                    <div class="space-y-xl">
                        <!-- What Others Do -->
                        <div>
                            <h4 class="subsection-heading color-error mb-lg">What Others Do:</h4>
                            <div class="space-y-md">
                                <div class="benefit-item">
                                    <span class="color-error mr-md font-body-600">✗</span>
                                    <span class="benefit-description">Chase pain around your body</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="color-error mr-md font-body-600">✗</span>
                                    <span class="benefit-description">Temporary relief that doesn't last</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="color-error mr-md font-body-600">✗</span>
                                    <span class="benefit-description">Generic treatment plans</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="color-error mr-md font-body-600">✗</span>
                                    <span class="benefit-description">Focus only on symptoms</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- What We Do -->
                        <div>
                            <h4 class="subsection-heading color-success mb-lg">What We Do:</h4>
                            <div class="space-y-md">
                                <div class="benefit-item">
                                    <span class="color-success mr-md font-body-600">✓</span>
                                    <span class="benefit-description">Find and fix the root cause</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="color-success mr-md font-body-600">✓</span>
                                    <span class="benefit-description">Lasting change through fascial release</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="color-success mr-md font-body-600">✓</span>
                                    <span class="benefit-description">Personalized to your body's patterns</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="color-success mr-md font-body-600">✓</span>
                                    <span class="benefit-description">Teach your body to stay pain-free</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Elegant CTA -->
                    <div class="text-center mt-xl pt-xl border-sage-100">
                        <p class="body-large mb-lg color-warm-gray-800" style="font-weight: 500;">
                            Stop managing pain. Start living without it.
                        </p>
                        <a href="#booking" class="btn-luxury btn-secondary">
                            Book via Web
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
        </section>

        <!-- About Section -->
        <section id="about" class="luxury-section" style="background: linear-gradient(180deg, var(--warm-gray-50) 0%, var(--beige-soft) 100%);">
            <div class="mobile-container">
                <div class="luxury-card-elevated animate-fade-in">
                    <div class="text-center mb-xl">
                        <h2 class="section-heading" id="dr-shiffer">Dr. Shiffer, CST, LMT</h2>
                        <p class="subtitle">Cranial Sacral Therapist • Licensed Massage Therapist</p>
                        <p class="body-text" style="color: var(--sage-600); margin-top: var(--space-sm);">Movement Specialist</p>
                    </div>
                    
                    <div class="space-y-lg">
                        <p class="body-large">
                            With nearly 20 years of experience in integrative bodywork, Dr. Shiffer brings a unique blend of traditional techniques and innovative approaches to healing.
                        </p>
                        
                        <p class="body-text">
                            Creator of the Fascial Neural Reset™ system, Dr. Shiffer's approach addresses the root causes of pain and tension, not just the symptoms.
                        </p>
                        
                        <!-- Stats -->
                        <div class="flex flex-row flex-wrap justify-between items-center mt-xl pt-xl border-sage-100">
                            <div class="text-center flex-1 flex flex-col">
                                <div class="stat-number">98%</div>
                                <div class="stat-label">Client Satisfaction</div>
                            </div>
                            <div class="text-center flex-1 flex flex-col">
                                <div class="stat-number">18+</div>
                                <div class="stat-label">Years Experience</div>
                            </div>
                            <div class="text-center flex-1 flex flex-col">
                                <div class="stat-number">1000+</div>
                                <div class="stat-label">Lives Transformed</div>
                            </div>
                        </div>
                        
                        <!-- Client Testimonials -->
                        <div class="mt-xl pt-xl border-sage-100">
                            <div class="testimonials-section">
                                <div class="testimonial-item mb-lg" style="background: var(--sage-50); padding: 1.5rem; border-radius: var(--radius-md); border-left: 4px solid var(--sage-400);">
                                    <div class="testimonial-content">
                                        <p class="body-text" style="font-style: italic; color: var(--sage-700); margin-bottom: 1rem;">"Working alongside Dr. Salina as both a business partner and client has been genuinely transformative. Her approach transcends physical relief—each session becomes an educational journey guided by her intuitive touch and profound understanding of the body. What sets her apart is how she reminds you of your body's innate capacity for healing. Every session feels deeply personalized, thoroughly professional, and authentically restorative. I consistently leave feeling refreshed, rebalanced, and deeply grateful."</p>
                                        <div class="testimonial-author" style="display: flex; align-items: center; justify-content: space-between;">
                                            <div class="author-info">
                                                <div class="author-name" style="font-weight: 600; color: var(--sage-800);">Curtis A. Jr.</div>
                                                <div class="author-title" style="font-size: 0.875rem; color: var(--sage-600);">Business Partner & Client</div>
                                            </div>
                                            <div class="rating" style="color: #fbbf24; font-size: 1.125rem;">★★★★★</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="testimonial-item" style="background: var(--sage-50); padding: 1.5rem; border-radius: var(--radius-md); border-left: 4px solid var(--sage-400);">
                                    <div class="testimonial-content">
                                        <p class="body-text" style="font-style: italic; color: var(--sage-700); margin-bottom: 1rem;">"Dr. Shiffer is extraordinary. Her therapeutic touch is unmatched—I've never experienced massages or craniosacral work like hers. I carry significant tension in my neck and skull, and by session's end, I'm completely relaxed, feeling like an entirely new person. Despite my usual anxiety around bodywork, Dr. Shiffer creates such a safe, comfortable space that I'm completely at ease. What I especially value is her commitment to empowering me with exercises and tools to support my healing between sessions. 

My husband, a large man who's endured over 15 surgeries including six back procedures, trusts her completely. He often marvels at how this 'small woman gives the most powerful massage he's ever received' and won't see anyone else. That level of trust from someone who's been through extensive medical treatment speaks volumes. I wholeheartedly recommend her—we won't go to anyone else."</p>
                                        <div class="testimonial-author" style="display: flex; align-items: center; justify-content: space-between;">
                                            <div class="author-info">
                                                <div class="author-name" style="font-weight: 600; color: var(--sage-800);">Peggy H.</div>
                                                <div class="author-title" style="font-size: 0.875rem; color: var(--sage-600);">Long-term Client</div>
                                            </div>
                                            <div class="rating" style="color: #fbbf24; font-size: 1.125rem;">★★★★★</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inspirational Quote -->
                        <div class="text-center mt-xl">
                            <p class="luxury-quote">
                                Healing happens when we create space for it
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
        </section>

        <!-- Six Modalities Section -->
        <section id="six-modalities" class="luxury-section" style="background: linear-gradient(180deg, var(--lavender-50) 0%, var(--neutral) 100%);">
            <div class="mobile-container">
                <div class="text-center mb-xl">
                    <h2 id="six-modalities-heading" class="section-heading" style="font-style: italic; background: linear-gradient(135deg, var(--sage-600) 0%, var(--lavender-600) 50%, var(--sage-800) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 2px 4px rgba(0,0,0,0.1); letter-spacing: 0.02em;">What We Do: 6 Healing Modalities</h2>
                    <p class="body-large" style="max-width: 300px; margin: 0 auto;">
                        Experience the power of integrated therapy where 6 distinct healing techniques blend seamlessly
                    </p>
                </div>
                
                <!-- Modalities Grid -->
                <div id="healing-modalities-grid" class="modalities-grid">
                    <!-- Modality 1: Fascial Release -->
                    <div id="first-modality" class="luxury-card animate-fade-in animate-stagger-1">
                        <div class="flex flex-row flex-wrap items-start">
                            <div class="benefit-icon mr-md" style="background: linear-gradient(135deg, var(--sage-500), var(--sage-700));">
                                <span style="font-size: 1rem; color: white;">1</span>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm" style="font-size: 1.125rem;">Fascial Neural Reset™</h3>
                                <p class="body-text mb-0" style="font-size: 0.9375rem;">
                                    Dr. Shiffer's proprietary technique that targets the fascial system to reset neural patterns and release chronic tension.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modality 2: Cranial Sacral Therapy -->
                    <div class="luxury-card animate-fade-in animate-stagger-2">
                        <div class="flex flex-row flex-wrap items-start">
                            <div class="benefit-icon mr-md" style="background: linear-gradient(135deg, var(--lavender-300), var(--sage-accent));">
                                <span style="font-size: 1rem; color: white;">2</span>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm" style="font-size: 1.125rem;">Cranial Sacral Therapy (CST)</h3>
                                <p class="body-text mb-0" style="font-size: 0.9375rem;">
                                    Gentle manipulation of the cranial bones and sacrum to release restrictions in the central nervous system, promoting deep healing and relaxation.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modality 3: Myofascial Therapy -->
                    <div class="luxury-card animate-fade-in animate-stagger-3">
                        <div class="flex flex-row flex-wrap items-start">
                            <div class="benefit-icon mr-md" style="background: linear-gradient(135deg, var(--ocean-mist), var(--sage-600));">
                                <span style="font-size: 1rem; color: white;">3</span>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm" style="font-size: 1.125rem;">Myofascial Therapy</h3>
                                <p class="body-text mb-0" style="font-size: 0.9375rem;">
                                    Specialized techniques that release adhesions and restore mobility in the connective tissue web that surrounds and supports every muscle in your body.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modality 4: Lymphatic Drainage -->
                    <div class="luxury-card animate-fade-in animate-stagger-4">
                        <div class="flex flex-row flex-wrap items-start">
                            <div class="benefit-icon mr-md" style="background: linear-gradient(135deg, var(--lavender-client), var(--neutral));">
                                <span style="font-size: 1rem; color: white;">4</span>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm" style="font-size: 1.125rem;">Lymphatic Drainage</h3>
                                <p class="body-text mb-0" style="font-size: 0.9375rem;">
                                    Gentle techniques that stimulate lymph flow to reduce swelling, boost immunity, and accelerate your body's natural detoxification process.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modality 5: Movement Integration -->
                    <div class="luxury-card animate-fade-in animate-stagger-5">
                        <div class="flex flex-row flex-wrap items-start">
                            <div class="benefit-icon mr-md" style="background: linear-gradient(135deg, var(--sage-accent), var(--ocean-mist));">
                                <span style="font-size: 1rem; color: white;">5</span>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm" style="font-size: 1.125rem;">Movement Re-education</h3>
                                <p class="body-text mb-0" style="font-size: 0.9375rem;">
                                    Teaching your body new, healthier movement patterns to prevent future pain and maintain optimal function.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modality 6: Therapeutic Massage -->
                    <div class="luxury-card animate-fade-in animate-stagger-6">
                        <div class="flex flex-row flex-wrap items-start">
                            <div class="benefit-icon mr-md" style="background: linear-gradient(135deg, var(--neutral-dark), var(--lavender-500));">
                                <span style="font-size: 1rem; color: white;">6</span>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <h3 class="subsection-heading mt-0 mb-sm" style="font-size: 1.125rem;">Licensed Massage Therapy</h3>
                                <p class="body-text mb-0" style="font-size: 0.9375rem;">
                                    Professional therapeutic massage techniques tailored to your specific needs, from deep tissue to gentle Swedish strokes.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Why This Matters -->
                <div class="luxury-card-elevated animate-fade-in bg-why-integrated" style="margin-top: var(--space-3xl);">
                    <div class="text-center">
                        <h3 class="subsection-heading" style="color: var(--lavender-600);">Why This Integrated Approach?</h3>
                        <p class="body-large mb-lg">
                            Your body is complex. Your treatment should be too.
                        </p>
                        <p class="body-text">
                            Instead of seeing 6 different practitioners, Dr. Shiffer seamlessly blends all these modalities in each session, creating a synergistic healing experience that addresses multiple layers of dysfunction simultaneously.
                        </p>
                        <div class="mt-xl pt-lg border-lavender-100">
                            <p class="luxury-quote color-sage-700">
                                "True healing happens when we address the whole person, not just the symptoms"
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
        </section>

        <!-- App-First Pricing Section -->
        <section id="pricing" class="luxury-section luxury-section-accent">
            <div class="mobile-container">
                <div class="text-center mb-xl">
                    <h2 class="section-heading">Book Your Session</h2>
                    <p class="body-large" style="max-width: 450px; margin: 0 auto;">
                        Get the best experience and pricing with our healing app, or book directly below
                    </p>
                    <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #fef7cd, #fbbf24); border-radius: var(--radius-md); color: #92400e; font-weight: 600; font-size: 0.875rem;">
                        ⏰ <strong>Limited Time:</strong> Introductory pricing - 25% off all sessions until August 2025
                    </div>
                </div>

                <!-- Book Online Button -->
                <div class="text-center mb-xl animate-fade-in" style="margin-top: 2rem; margin-bottom: 2rem;">
                    <a href="#booking" class="luxury-button-secondary" aria-label="Book appointment online without downloading app">
                        Book Online Without App
                    </a>
                </div>

                <!-- Premium App Experience CTA -->
                <div class="luxury-card-elevated mb-xl" style="background: linear-gradient(135deg, #059669 0%, #065f46 100%); color: white; text-align: center; border: 3px solid #10b981; box-shadow: 0 12px 40px rgba(5, 150, 105, 0.4);">
                    <div style="padding: 2.5rem 1.5rem;">
                        <div style="background: rgba(255,255,255,0.15); border-radius: 50%; width: 80px; height: 80px; margin: 0 auto 1rem auto; display: flex; align-items: center; justify-content: center;">
                            <div style="font-size: 3rem;">📱</div>
                        </div>
                        <h2 style="color: white; font-size: 2rem; margin: 0 0 1rem 0; font-weight: 700;">The Ultimate Healing Experience</h2>
                        <p style="color: rgba(255,255,255,0.95); font-size: 1.1rem; margin: 0 0 1.5rem 0; font-weight: 500;">
                            Why settle for basic when you can have premium?
                        </p>
                        
                        <!-- Feature Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🧠</div>
                                <div style="font-weight: 600; font-size: 0.9rem;">AI Pain Tracking</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">💰</div>
                                <div style="font-weight: 600; font-size: 0.9rem;">Save $10/Session</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⚡</div>
                                <div style="font-weight: 600; font-size: 0.9rem;">Priority Booking</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🆓</div>
                                <div style="font-weight: 600; font-size: 0.9rem;">No Booking Fees</div>
                            </div>
                        </div>
                        
                        <!-- Launch Badge -->
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1rem 2rem; border-radius: 2rem; font-weight: 700; font-size: 1.1rem; margin: 1.5rem 0; display: inline-block; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);">
                            🚀 LAUNCHING MID AUGUST 2025
                        </div>
                        
                        <!-- Value Proposition -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                            <p style="font-size: 1rem; color: white; margin: 0; font-weight: 600;">
                                Regular users save $480+ per year with app pricing
                            </p>
                        </div>
                        
                        <p style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin: 1rem 0 0 0;">
                            Join the waitlist • Get notified first • Early bird specials
                        </p>
                    </div>
                </div>



                <!-- Tech Support & Phone Booking for Elderly -->
                <div class="luxury-card-elevated text-center" style="background: linear-gradient(145deg, #fef7e0, #fed7aa); border: 2px solid #f59e0b;">
                    <h3 class="subsection-heading mb-lg" style="color: #92400e;">Need Help with Technology?</h3>
                    <div style="font-size: 2rem; margin-bottom: 1rem;">🤝</div>
                    <p class="body-large mb-lg" style="color: #92400e;">
                        <strong>We're here to help!</strong> Call us at <strong><a href="tel:9402685999" style="color: #b45309; text-decoration: none;">940.268.5999</a></strong>
                    </p>
                    <div style="text-align: left; max-width: 400px; margin: 0 auto; background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 0.5rem;">
                        <p style="font-weight: 600; margin: 0 0 0.5rem 0; color: #92400e;">✓ We'll walk you through app download</p>
                        <p style="font-weight: 600; margin: 0 0 0.5rem 0; color: #92400e;">✓ Book your appointment over the phone</p>
                        <p style="font-weight: 600; margin: 0 0 0.5rem 0; color: #92400e;">✓ Have a family member help you set up</p>
                        <p style="font-weight: 600; margin: 0; color: #92400e;">✓ No tech skills required - we guide you</p>
                    </div>
                    <p class="body-text" style="color: #a16207; margin-top: 1rem;">
                        <strong>Age-friendly service:</strong> Large text, simple steps, patient support
                    </p>
                </div>

            </div>
            
            <div class="section-divider"></div>
        </section>


        <!-- Luxury What Awaits You Section -->
        <section class="luxury-section">
            <div class="mobile-container">
                <div class="text-center mb-xl">
                    <h2 class="section-heading">What Awaits You</h2>
                </div>
                
                <div class="benefits-grid">
                    <!-- Benefit 1 -->
                    <div class="benefit-item luxury-card animate-fade-in animate-stagger-1">
                        <div class="benefit-icon">
                            <span style="font-size: 1rem; color: white;">✧</span>
                        </div>
                        <div class="benefit-content">
                            <h3 class="benefit-title">Comprehensive Assessment</h3>
                            <p class="benefit-description">Personalized evaluation of your unique body patterns and healing needs</p>
                        </div>
                    </div>
                    
                    <!-- Benefit 2 -->
                    <div class="benefit-item luxury-card animate-fade-in animate-stagger-2">
                        <div class="benefit-icon" style="background: linear-gradient(135deg, var(--soft-lavender), var(--sage-500));">
                            <span style="font-size: 1rem; color: white;">❋</span>
                        </div>
                        <div class="benefit-content">
                            <h3 class="benefit-title">Tailored Treatment Plan</h3>
                            <p class="benefit-description">Customized healing journey designed specifically for your wellness goals</p>
                        </div>
                    </div>
                    
                    <!-- Benefit 3 -->
                    <div class="benefit-item luxury-card animate-fade-in animate-stagger-3">
                        <div class="benefit-icon" style="background: linear-gradient(135deg, var(--ocean-mist), var(--sage-600));">
                            <span style="font-size: 1rem; color: white;">◈</span>
                        </div>
                        <div class="benefit-content">
                            <h3 class="benefit-title">Gentle Techniques</h3>
                            <p class="benefit-description">Effective methods that honor your body's natural wisdom and healing capacity</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
        </section>

        <!-- Enhanced Booking Section -->
        <section id="booking" class="luxury-section luxury-section-accent">
            <div class="mobile-container">
                <div class="text-center mb-xl">
                    <div class="benefit-icon mx-auto mb-lg" style="width: 3rem; height: 3rem;">
                        <svg style="width: 1.5rem; height: 1.5rem; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    
                    <h2 class="section-heading mb-lg">Book Your Healing Session</h2>
                    <p class="body-large" style="max-width: 300px; margin: 0 auto;">
                        Choose the session duration that best supports your healing needs
                    </p>
                </div>

                <!-- Real Booking Form -->
                <div class="booking-section">
                    <div class="booking-container luxury-card-elevated mb-xl">
                        
                            <!-- Real Booking Form JavaScript Integration -->
                            <script>
                                let currentStep = 1;
                                let selectedService = null;
                                let selectedPrice = 0;
                                const basePrices = { '60min': 135, '90min': 180, '120min': 225, 'consultation': 60, 'test': 1.00 };
                                
                                // Analytics tracking object
                                const bookingAnalytics = {
                                    session_start: new Date().toISOString(),
                                    steps_completed: [],
                                    services_viewed: [],
                                    addons_selected: [],
                                    total_time_seconds: 0,
                                    abandoned: false
                                };
                                
                                // Track page load
                                console.log('📊 Analytics: Booking Form Loaded', {
                                    timestamp: bookingAnalytics.session_start,
                                    referrer: document.referrer,
                                    device_type: /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'mobile' : 'desktop'
                                });

                                function selectService(serviceType, price) {
                                    selectedService = serviceType;
                                    selectedPrice = parseInt(price.replace('$', ''));
                                    
                                    // Track service selection for analytics
                                    console.log('📊 Analytics: Service Selected', {
                                        service_type: serviceType,
                                        service_price: selectedPrice,
                                        timestamp: new Date().toISOString(),
                                        user_agent: navigator.userAgent,
                                        page_url: window.location.href
                                    });
                                    
                                    // Highlight selected service
                                    document.querySelectorAll('.service-option').forEach(el => {
                                        el.style.borderColor = '#e2e8f0';
                                        el.style.background = 'white';
                                        el.classList.remove('active');
                                    });
                                    const selectedOption = event.target.closest('.service-option');
                                    selectedOption.style.borderColor = '#10b981';
                                    selectedOption.style.background = '#f0f9ff';
                                    selectedOption.classList.add('active');
                                    selectedOption.dataset.service = serviceType;
                                    
                                    // Trigger availability refresh if date is already selected
                                    if (window.BookingAvailability) {
                                        const selectedDate = document.getElementById('booking-date')?.value;
                                        if (selectedDate) {
                                            window.BookingAvailability.refresh();
                                        }
                                    }
                                    
                                    // Dispatch custom event for service selection
                                    document.dispatchEvent(new CustomEvent('serviceSelected', {
                                        detail: { 
                                            service: serviceType,
                                            price: selectedPrice
                                        }
                                    }));
                                    
                                    // Show next button
                                    document.getElementById('next-btn').style.display = 'inline-block';
                                }
                                
                                // Show complimentary booking notice
                                function showComplimentaryNotice() {
                                    let notice = document.getElementById('complimentary-notice');
                                    if (!notice) {
                                        notice = document.createElement('div');
                                        notice.id = 'complimentary-notice';
                                        notice.className = 'luxury-card-elevated';
                                        notice.style.cssText = `
                                            margin-top: 1rem;
                                            padding: 1rem;
                                            background: linear-gradient(135deg, #f3e8ff, #e0e7ff);
                                            border: 2px solid #8b5cf6;
                                            border-radius: 12px;
                                            text-align: center;
                                        `;
                                        notice.innerHTML = `
                                            <h4 style="color: #7c3aed; margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: 700;">📝 Complimentary Session Request</h4>
                                            <p style="color: #6b46c1; font-size: 0.9rem; margin: 0; line-height: 1.4;">
                                                Your request will be reviewed by our admin team. You'll receive an email and SMS notification with the approval decision.
                                            </p>
                                        `;
                                        document.querySelector('.service-options').appendChild(notice);
                                    }
                                    notice.style.display = 'block';
                                }
                                
                                // Hide complimentary booking notice
                                function hideComplimentaryNotice() {
                                    const notice = document.getElementById('complimentary-notice');
                                    if (notice) {
                                        notice.style.display = 'none';
                                    }
                                }

                                // Function to load and apply closed dates restrictions
                                async function loadClosedDates() {
                                    try {
                                        const response = await fetch('/api/web-booking/closed-dates');
                                        const data = await response.json();
                                        
                                        if (data.success && data.data.closed_dates) {
                                            window.closedDates = data.data.closed_dates;
                                            console.log('Loaded', data.data.closed_dates.length, 'closed dates');
                                            
                                            // Check if there are admin overrides
                                            if (data.data.has_overrides) {
                                                console.log('Admin availability overrides detected');
                                            }
                                            
                                            // Set date input constraints
                                            setupDateConstraints(data.data);
                                            
                                            // Show availability info on load
                                            const dateInfo = document.getElementById('date-availability-info');
                                            if (dateInfo) {
                                                dateInfo.style.display = 'block';
                                            }
                                        }
                                    } catch (error) {
                                        console.error('Failed to load closed dates:', error);
                                        window.closedDates = [];
                                    }
                                }
                                
                                // Refresh closed dates periodically to sync with admin changes
                                function startAvailabilitySync() {
                                    // Refresh every 30 seconds
                                    setInterval(async () => {
                                        await loadClosedDates();
                                        
                                        // If user has a date selected, revalidate it
                                        const dateInput = document.getElementById('booking-date');
                                        if (dateInput && dateInput.value) {
                                            validateDateSelection(dateInput);
                                        }
                                    }, 30000);
                                }
                                
                                // Function to setup date constraints and provide helpful guidance
                                function setupDateConstraints(dateData) {
                                    const dateInput = document.getElementById('booking-date');
                                    if (!dateInput) return;
                                    
                                    // Set minimum date to today
                                    const today = new Date();
                                    const todayString = today.toISOString().split('T')[0];
                                    dateInput.setAttribute('min', todayString);
                                    
                                    // Set maximum date based on data (if available)
                                    if (dateData.end_date) {
                                        dateInput.setAttribute('max', dateData.end_date);
                                    } else {
                                        // Default to 90 days from today
                                        const maxDate = new Date(today);
                                        maxDate.setDate(maxDate.getDate() + 90);
                                        dateInput.setAttribute('max', maxDate.toISOString().split('T')[0]);
                                    }
                                    
                                    // Add helpful title attribute
                                    dateInput.setAttribute('title', 'Select an available date. Closed days: Tuesday, Thursday, Sunday');
                                    
                                    // Add input event listener to validate in real-time
                                    dateInput.addEventListener('input', function(e) {
                                        // Prevent selection of closed dates
                                        if (isDateClosed(e.target.value)) {
                                            e.target.setCustomValidity('This date is not available. Please select an available date.');
                                            validateDateSelection(e.target);
                                        } else {
                                            e.target.setCustomValidity('');
                                        }
                                    });
                                }
                                
                                
                                // Function to check if a date is closed
                                function isDateClosed(dateString) {
                                    if (!window.closedDates) return false;
                                    return window.closedDates.includes(dateString);
                                }
                                
                                // Function to validate date selection with visual feedback
                                function validateDateSelection(dateInput) {
                                    const selectedDate = dateInput.value;
                                    const dateInfo = document.getElementById('date-availability-info');
                                    const closedWarning = document.getElementById('closed-date-warning');
                                    const availableHint = document.getElementById('available-days-hint');
                                    
                                    if (!selectedDate) {
                                        // Show general availability info when no date selected
                                        if (dateInfo) {
                                            dateInfo.style.display = 'block';
                                            closedWarning.style.display = 'none';
                                            availableHint.style.display = 'block';
                                        }
                                        dateInput.classList.remove('date-valid', 'date-invalid');
                                        return true;
                                    }
                                    
                                    if (isDateClosed(selectedDate)) {
                                        // Show visual warning for closed dates
                                        if (dateInfo && closedWarning) {
                                            dateInfo.style.display = 'block';
                                            closedWarning.style.display = 'block';
                                            availableHint.style.display = 'block';
                                            
                                            // Add red border to indicate error
                                            dateInput.classList.remove('date-valid');
                                            dateInput.classList.add('date-invalid');
                                            dateInput.style.borderColor = '#dc2626';
                                            dateInput.style.backgroundColor = '#fef2f2';
                                        }
                                        
                                        // Clear the invalid date after showing feedback
                                        setTimeout(() => {
                                            dateInput.value = '';
                                            dateInput.style.borderColor = '#e2e8f0';
                                            dateInput.style.backgroundColor = '';
                                            dateInput.classList.remove('date-invalid');
                                            if (closedWarning) closedWarning.style.display = 'none';
                                        }, 3000);
                                        
                                        return false;
                                    }
                                    
                                    // Valid date selected - hide warnings, show success
                                    if (dateInfo) {
                                        dateInfo.style.display = 'block';
                                        closedWarning.style.display = 'none';
                                        availableHint.style.display = 'none';
                                        
                                        // Add green border to indicate success
                                        dateInput.classList.remove('date-invalid');
                                        dateInput.classList.add('date-valid');
                                        dateInput.style.borderColor = '#10b981';
                                        dateInput.style.backgroundColor = '#f0fdf4';
                                    }
                                    
                                    return true;
                                }

                                // Function to validate time selection with real-time availability checking
                                async function validateTimeSelection(selectedDate, selectedTime) {
                                    try {
                                        const practitionerId = '060863f2-0623-4785-b01a-f1760cfb8d14';
                                        const serviceType = document.querySelector('.service-option.active')?.dataset?.serviceType || '60min_massage';
                                        
                                        // Check real-time availability for selected time slot
                                        const response = await fetch(`/api/web-booking/availability/${practitionerId}/${selectedDate}?service_type=${serviceType}`);
                                        
                                        if (!response.ok) {
                                            throw new Error('Failed to validate time selection');
                                        }
                                        
                                        const data = await response.json();
                                        
                                        if (data.success && data.data.available_slots) {
                                            const availableSlots = data.data.available_slots;
                                            const isTimeAvailable = availableSlots.some(slot => {
                                                const slotTime = new Date(slot.time);
                                                const timeString = slotTime.toLocaleTimeString('en-US', { 
                                                    hour: '2-digit', 
                                                    minute: '2-digit',
                                                    hour12: false 
                                                });
                                                return timeString === selectedTime;
                                            });
                                            
                                            if (!isTimeAvailable) {
                                                // Show warning to user
                                                const timeHelp = document.getElementById('booking-time-help');
                                                if (timeHelp) {
                                                    timeHelp.textContent = 'This time slot is no longer available. Please select another time.';
                                                    timeHelp.style.color = '#dc2626';
                                                }
                                                
                                                // Clear the time selection
                                                const timeSelect = document.getElementById('booking-time');
                                                timeSelect.value = '';
                                                
                                                // Refresh available slots
                                                if (window.BookingAvailability) {
                                                    window.BookingAvailability.refresh();
                                                }
                                                return false;
                                            }
                                        }
                                        
                                        return true;
                                    } catch (error) {
                                        console.error('Error validating time selection:', error);
                                        return true; // Allow booking to proceed on error
                                    }
                                }

                                function loadTimeSlots(retryCount = 0) {
                                    const dateInput = document.getElementById('booking-date');
                                    const timeSelect = document.getElementById('booking-time');
                                    const loadingDiv = document.getElementById('time-loading');
                                    const maxRetries = 3;
                                    const retryDelay = 1000; // 1 second
                                    
                                    if (!dateInput.value) {
                                        timeSelect.innerHTML = '<option value="">Select date first...</option>';
                                        return;
                                    }
                                    
                                    // Show loading state
                                    loadingDiv.style.display = 'block';
                                    loadingDiv.innerHTML = retryCount > 0 ? 
                                        '<div style="color: #f59e0b;">Retrying... (Attempt ' + (retryCount + 1) + '/' + (maxRetries + 1) + ')</div>' : 
                                        'Loading available times...';
                                    timeSelect.innerHTML = '<option value="">Loading...</option>';
                                    timeSelect.disabled = true;
                                    
                                    const practitionerId = '060863f2-0623-4785-b01a-f1760cfb8d14';
                                    const selectedDate = dateInput.value;
                                    const serviceType = document.querySelector('.service-option.active')?.dataset?.serviceType || '60min_massage';
                                    
                                    // Set a timeout for the fetch request
                                    const fetchTimeout = setTimeout(() => {
                                        handleFetchError('Request timed out', retryCount);
                                    }, 10000);
                                    
                                    fetch(`/api/web-booking/availability/${practitionerId}/${selectedDate}?service_type=${serviceType}`)
                                        .then(response => {
                                            clearTimeout(fetchTimeout);
                                            
                                            if (!response.ok) {
                                                throw new Error(`HTTP error! status: ${response.status}`);
                                            }
                                            return response.json();
                                        })
                                        .then(data => {
                                            if (!data.success) {
                                                throw new Error(data.error || 'Failed to load availability');
                                            }
                                            
                                            const slots = data.data.available_slots || [];
                                            
                                            timeSelect.innerHTML = '<option value="">Select time...</option>';
                                            
                                            if (slots.length === 0) {
                                                timeSelect.innerHTML = '<option value="">No available times for this date</option>';
                                                loadingDiv.innerHTML = '<div style="color: #dc2626;">No appointments available on this date. Please try another date.</div>';
                                                loadingDiv.style.display = 'block';
                                            } else {
                                                slots.forEach(slot => {
                                                    const option = document.createElement('option');
                                                    const slotTime = new Date(slot.time);
                                                    const timeString = slotTime.toLocaleTimeString('en-US', { 
                                                        hour: '2-digit', 
                                                        minute: '2-digit',
                                                        hour12: false 
                                                    });
                                                    option.value = timeString;
                                                    option.textContent = slot.display_time;
                                                    timeSelect.appendChild(option);
                                                });
                                                loadingDiv.style.display = 'none';
                                            }
                                            
                                            timeSelect.disabled = false;
                                        })
                                        .catch(error => {
                                            clearTimeout(fetchTimeout);
                                            handleFetchError(error.message, retryCount);
                                        });
                                    
                                    function handleFetchError(errorMessage, currentRetry) {
                                        if (currentRetry < maxRetries) {
                                            setTimeout(() => {
                                                loadTimeSlots(currentRetry + 1);
                                            }, retryDelay);
                                        } else {
                                            timeSelect.innerHTML = '<option value="">Error loading times - Please refresh page</option>';
                                            timeSelect.disabled = false;
                                            loadingDiv.innerHTML = `
                                                <div style="color: #dc2626; margin-top: 10px;">
                                                    <strong>Unable to load available times</strong><br>
                                                    <span style="font-size: 14px;">Please check your internet connection and try again.</span><br>
                                                    <button id="load-time-slots-btn" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                        Retry
                                                    </button>
                                                </div>
                                            `;
                                            loadingDiv.style.display = 'block';
                                        }
                                    }
                                }

                                function updateTotalPrice() {
                                    const locationType = document.getElementById('location-type').value;
                                    const basePrice = basePrices[selectedService] || 0;
                                    const mobileUpcharge = 0;
                                    
                                    // Calculate add-on prices
                                    let addonTotal = 0;
                                    const addonCheckboxes = document.querySelectorAll('.addon-option input[type="checkbox"]:checked');
                                    addonCheckboxes.forEach(checkbox => {
                                        const addonPrice = parseInt(checkbox.getAttribute('data-price'));
                                        addonTotal += addonPrice;
                                    });
                                    
                                    const total = basePrice + mobileUpcharge + addonTotal;
                                    
                                    // Check if comp payment is selected
                                    const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value;
                                    const displayTotal = selectedPaymentMethod === 'comp' ? 0 : total;
                                    
                                    document.getElementById('total-price').textContent = '$' + displayTotal;
                                    return total; // Return actual total for calculations, display will show 0 for comp
                                }

                                async function nextStep() {
                                    // Track step progression
                                    console.log('📊 Analytics: Next Step', {
                                        from_step: currentStep,
                                        to_step: currentStep + 1,
                                        timestamp: new Date().toISOString()
                                    });
                                    
                                    if (currentStep === 1) {
                                        if (!selectedService) {
                                            alert('Please select a session type.');
                                            return;
                                        }
                                        await transitionStep('service-selection', 'datetime-selection');
                                        document.getElementById('prev-btn').style.display = 'inline-block';
                                        
                                        // Allow same-day booking
                                        const today = new Date();
                                        const todayStr = today.toISOString().split('T')[0];
                                        const bookingDateInput = document.getElementById('booking-date');
                                        bookingDateInput.min = todayStr;
                                        
                                        // Set maximum date to 90 days from today
                                        const maxDate = new Date();
                                        maxDate.setDate(maxDate.getDate() + 90);
                                        bookingDateInput.max = maxDate.toISOString().split('T')[0];
                                        
                                        // Load and apply closed dates
                                        loadClosedDates();
                                        startAvailabilitySync();
                                        
                                        currentStep = 2;
                                    } else if (currentStep === 2) {
                                        const date = document.getElementById('booking-date').value;
                                        const time = document.getElementById('booking-time').value;
                                        
                                        if (!date || !time) {
                                            alert('Please select both date and time.');
                                            return;
                                        }
                                        
                                        await transitionStep('datetime-selection', 'contact-info');
                                        currentStep = 3;
                                    } else if (currentStep === 3) {
                                        const name = document.getElementById('client-name').value.trim();
                                        const email = document.getElementById('client-email').value.trim();
                                        const phone = document.getElementById('client-phone').value.trim();
                                        
                                        // Comprehensive field validation
                                        const validationResult = validateBookingFields(name, email, phone);
                                        if (!validationResult.isValid) {
                                            alert(validationResult.message);
                                            return;
                                        }
                                        
                                        // Validate comp type if comp payment method is selected
                                        const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value || 'credit_card';
                                        if (selectedPaymentMethod === 'comp') {
                                            const compType = document.getElementById('comp-type').value;
                                            if (!compType) {
                                                alert('Please select a comp type for complimentary bookings.');
                                                return;
                                            }
                                        }
                                        
                                        // Critical fix: Use async transition with proper DOM settling
                                        await transitionStep('contact-info', 'payment-info');
                                        
                                        // Only initialize Stripe for credit card payments
                                        // Note: selectedPaymentMethod is already defined above
                                        
                                        if (selectedPaymentMethod === 'credit_card') {
                                            // Wait for DOM to fully settle before Stripe initialization
                                            await waitForFrameStability();
                                            
                                            // Initialize Stripe Elements with frame validation
                                            await initializeStripeElementsSafely();
                                        }
                                        
                                        // Update payment total
                                        const total = updateTotalPrice();
                                        document.getElementById('payment-total-price').textContent = '$' + total;
                                        
                                        currentStep = 4;
                                    } else if (currentStep === 4) {
                                        await transitionStep('payment-info', 'booking-summary');
                                        document.getElementById('next-btn').style.display = 'none';
                                        
                                        updateBookingSummary();
                                        currentStep = 5;
                                    }
                                }

                                // Comprehensive field validation function
                                function validateBookingFields(name, email, phone) {
                                    // Mandatory field check
                                    if (!name || !email || !phone) {
                                        return { isValid: false, message: 'Please fill in all required fields (Name, Email, Phone).' };
                                    }
                                    
                                    // Name validation: at least two words, 3+ characters each
                                    const nameWords = name.split(/\s+/).filter(word => word.length > 0);
                                    if (nameWords.length < 2) {
                                        return { isValid: false, message: 'Please enter your full name (first and last name).' };
                                    }
                                    
                                    // Check each name part has at least 3 characters
                                    for (const word of nameWords) {
                                        if (word.length < 3) {
                                            return { isValid: false, message: 'Each part of your name must be at least 3 characters long.' };
                                        }
                                    }
                                    
                                    // Name should only contain letters, spaces, hyphens, apostrophes
                                    const nameRegex = /^[a-zA-Z\s\-']+$/;
                                    if (!nameRegex.test(name)) {
                                        return { isValid: false, message: 'Name can only contain letters, spaces, hyphens, and apostrophes.' };
                                    }
                                    
                                    // Email validation with real domain and TLD checks
                                    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                                    if (!emailRegex.test(email)) {
                                        return { isValid: false, message: 'Please enter a valid email address with a real domain (e.g., name@domain.com).' };
                                    }
                                    
                                    // Additional email domain validation
                                    const emailParts = email.split('@');
                                    if (emailParts.length !== 2) {
                                        return { isValid: false, message: 'Email address format is invalid.' };
                                    }
                                    
                                    const domain = emailParts[1];
                                    const domainParts = domain.split('.');
                                    if (domainParts.length < 2) {
                                        return { isValid: false, message: 'Email address must have a valid domain with extension (e.g., .com, .org).' };
                                    }
                                    
                                    // Check TLD is at least 2 characters
                                    const tld = domainParts[domainParts.length - 1];
                                    if (tld.length < 2) {
                                        return { isValid: false, message: 'Email address must have a valid domain extension.' };
                                    }
                                    
                                    // Phone number validation
                                    // Remove all non-numeric characters for validation
                                    const phoneNumbers = phone.replace(/\D/g, '');
                                    
                                    // Check length (US phone numbers should be 10 digits)
                                    if (phoneNumbers.length < 10) {
                                        return { isValid: false, message: 'Phone number must be at least 10 digits long.' };
                                    }
                                    
                                    if (phoneNumbers.length > 15) {
                                        return { isValid: false, message: 'Phone number is too long. Please enter a valid phone number.' };
                                    }
                                    
                                    // For US numbers (10 digits), validate area code and prefix
                                    if (phoneNumbers.length === 10) {
                                        const areaCode = phoneNumbers.substring(0, 3);
                                        const prefix = phoneNumbers.substring(3, 6);
                                        
                                        // Valid US area codes (major ones - can be expanded)
                                        const validAreaCodes = [
                                            '201', '202', '203', '205', '206', '207', '208', '209', '210', '212', '213', '214', '215', '216', '217', '218', '219',
                                            '224', '225', '228', '229', '231', '234', '239', '240', '248', '251', '252', '253', '254', '256', '260', '262', '267',
                                            '269', '270', '276', '281', '301', '302', '303', '304', '305', '307', '308', '309', '310', '312', '313', '314', '315',
                                            '316', '317', '318', '319', '320', '321', '323', '325', '330', '331', '334', '336', '337', '339', '340', '347', '351',
                                            '352', '360', '361', '386', '401', '402', '404', '405', '406', '407', '408', '409', '410', '412', '413', '414', '415',
                                            '417', '419', '423', '424', '425', '430', '432', '434', '435', '440', '442', '443', '458', '469', '470', '475', '478',
                                            '479', '480', '484', '501', '502', '503', '504', '505', '507', '508', '509', '510', '512', '513', '515', '516', '517',
                                            '518', '520', '530', '540', '541', '551', '559', '561', '562', '563', '564', '567', '570', '571', '573', '574', '575',
                                            '580', '585', '586', '601', '602', '603', '605', '606', '607', '608', '609', '610', '612', '614', '615', '616', '617',
                                            '618', '619', '620', '623', '626', '628', '629', '630', '631', '636', '641', '646', '650', '651', '660', '661', '662',
                                            '667', '678', '682', '701', '702', '703', '704', '706', '707', '708', '712', '713', '714', '715', '716', '717', '718',
                                            '719', '720', '724', '727', '731', '732', '734', '737', '740', '743', '747', '754', '757', '760', '762', '763', '765',
                                            '770', '772', '773', '774', '775', '781', '786', '787', '801', '802', '803', '804', '805', '806', '808', '810', '812',
                                            '813', '814', '815', '816', '817', '818', '828', '830', '831', '832', '843', '845', '847', '848', '850', '856', '857',
                                            '858', '859', '860', '862', '863', '864', '865', '870', '872', '878', '901', '903', '904', '906', '907', '908', '909',
                                            '910', '912', '913', '914', '915', '916', '917', '918', '919', '920', '925', '928', '929', '931', '936', '937', '938',
                                            '940', '941', '947', '949', '951', '952', '954', '956', '959', '970', '971', '972', '973', '978', '979', '980', '984',
                                            '985', '989'
                                        ];
                                        
                                        if (!validAreaCodes.includes(areaCode)) {
                                            return { isValid: false, message: 'Please enter a valid US area code.' };
                                        }
                                        
                                        // Prefix validation - cannot start with 0 or 1, cannot be 411 or 911 (555 is allowed for testing)
                                        if (prefix.startsWith('0') || prefix.startsWith('1')) {
                                            return { isValid: false, message: 'Phone number prefix cannot start with 0 or 1.' };
                                        }
                                        
                                        const invalidPrefixes = ['411', '911'];
                                        if (invalidPrefixes.includes(prefix)) {
                                            return { isValid: false, message: 'Phone number contains an invalid prefix.' };
                                        }
                                    }
                                    
                                    // Check for recursive number sequences (like 9999999999)
                                    const hasRecursiveSequence = /(\d)\1{4,}/.test(phoneNumbers);
                                    if (hasRecursiveSequence) {
                                        return { isValid: false, message: 'Phone number appears to have repeating digits. Please enter a valid phone number.' };
                                    }
                                    
                                    // Check for sequential patterns (like 1234567890)
                                    const hasSequentialPattern = /0123456789|1234567890|9876543210|0987654321/.test(phoneNumbers);
                                    if (hasSequentialPattern) {
                                        return { isValid: false, message: 'Phone number appears to be a sequential pattern. Please enter a valid phone number.' };
                                    }
                                    
                                    // Check for common fake numbers
                                    const fakePatterns = [
                                        /^1234567890$/,
                                        /^0000000000$/,
                                        /^1111111111$/,
                                        /^5555555555$/,
                                        /^9999999999$/,
                                        /^1234554321$/
                                    ];
                                    
                                    for (const pattern of fakePatterns) {
                                        if (pattern.test(phoneNumbers)) {
                                            return { isValid: false, message: 'Please enter a valid phone number.' };
                                        }
                                    }
                                    
                                    // All validation passed
                                    return { isValid: true };
                                }

                                // Real-time field validation function
                                function validateFieldRealTime(fieldId, fieldType) {
                                    const field = document.getElementById(fieldId);
                                    const errorDiv = document.getElementById(fieldId + '-error');
                                    const value = field.value.trim();
                                    
                                    let isValid = true;
                                    let errorMessage = '';
                                    
                                    if (fieldType === 'name') {
                                        // Enhanced name validation
                                        if (!value) {
                                            isValid = false;
                                            errorMessage = 'Full name is required.';
                                        } else {
                                            const nameWords = value.split(/\s+/).filter(word => word.length > 0);
                                            if (nameWords.length < 2) {
                                                isValid = false;
                                                errorMessage = 'Please enter your full name (first and last name).';
                                            } else if (nameWords.some(word => word.length < 3)) {
                                                isValid = false;
                                                errorMessage = 'Each part of your name must be at least 3 characters long.';
                                            } else if (!/^[a-zA-Z\s\-'\.]+$/.test(value)) {
                                                isValid = false;
                                                errorMessage = 'Name can only contain letters, spaces, hyphens, apostrophes, and periods.';
                                            } else if (value.length > 50) {
                                                isValid = false;
                                                errorMessage = 'Name must be less than 50 characters.';
                                            } else if (/\d/.test(value)) {
                                                isValid = false;
                                                errorMessage = 'Name cannot contain numbers.';
                                            } else if (/[!@#$%^&*()_+={}[\]|\\:";?<>,\/]/.test(value)) {
                                                isValid = false;
                                                errorMessage = 'Name contains invalid characters.';
                                            }
                                        }
                                    } else if (fieldType === 'email') {
                                        // Enhanced email validation
                                        if (!value) {
                                            isValid = false;
                                            errorMessage = 'Email address is required.';
                                        } else {
                                            // More comprehensive email regex
                                            const emailRegex = /^[a-zA-Z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/;
                                            
                                            if (!emailRegex.test(value)) {
                                                isValid = false;
                                                errorMessage = 'Please enter a valid email address.';
                                            } else if (value.length > 254) {
                                                isValid = false;
                                                errorMessage = 'Email address is too long.';
                                            } else {
                                                const [localPart, domain] = value.split('@');
                                                if (localPart.length > 64) {
                                                    isValid = false;
                                                    errorMessage = 'Email local part is too long.';
                                                } else if (domain.length > 253) {
                                                    isValid = false;
                                                    errorMessage = 'Email domain is too long.';
                                                } else {
                                                    // Check for common disposable email domains
                                                    const disposableDomains = ['10minutemail.com', 'throwaway.email', 'guerrillamail.com', 'mailinator.com', 'tempmail.org'];
                                                    if (disposableDomains.some(d => domain.toLowerCase().includes(d))) {
                                                        isValid = false;
                                                        errorMessage = 'Please use a permanent email address.';
                                                    }
                                                }
                                            }
                                        }
                                    } else if (fieldType === 'phone') {
                                        // Enhanced phone validation with comprehensive prefix checking
                                        if (!value) {
                                            isValid = false;
                                            errorMessage = 'Phone number is required.';
                                        } else {
                                            const phoneNumbers = value.replace(/\D/g, '');
                                            
                                            if (phoneNumbers.length === 0) {
                                                isValid = false;
                                                errorMessage = 'Please enter a valid phone number.';
                                            } else if (phoneNumbers.length < 10) {
                                                isValid = false;
                                                errorMessage = 'Phone number must be 10 digits long.';
                                            } else if (phoneNumbers.length > 11) {
                                                isValid = false;
                                                errorMessage = 'Phone number cannot be more than 11 digits.';
                                            } else if (phoneNumbers.length === 11 && !phoneNumbers.startsWith('1')) {
                                                isValid = false;
                                                errorMessage = 'For 11-digit numbers, must start with 1.';
                                            } else {
                                                // Extract area code and prefix for 10 or 11 digit numbers
                                                const effectiveNumber = phoneNumbers.length === 11 ? phoneNumbers.substring(1) : phoneNumbers;
                                                const areaCode = effectiveNumber.substring(0, 3);
                                                const prefix = effectiveNumber.substring(3, 6);
                                                const lineNumber = effectiveNumber.substring(6, 10);
                                                
                                                // Check for obviously fake patterns
                                                if (/(\d)\1{4,}/.test(phoneNumbers)) {
                                                    isValid = false;
                                                    errorMessage = 'Phone number appears to have too many repeating digits.';
                                                } else if (/^(0123456789|1234567890|9876543210|0987654321)$/.test(phoneNumbers)) {
                                                    isValid = false;
                                                    errorMessage = 'Please enter a real phone number.';
                                                } else if (/^(1111111111|0000000000|5555555555|9999999999|1234554321)$/.test(phoneNumbers)) {
                                                    isValid = false;
                                                    errorMessage = 'Please enter a real phone number.';
                                                } else if (areaCode === '000' || areaCode === '111') {
                                                    isValid = false;
                                                    errorMessage = 'Invalid area code.';
                                                } else if (areaCode.startsWith('0') || areaCode.startsWith('1')) {
                                                    isValid = false;
                                                    errorMessage = 'Area code cannot start with 0 or 1.';
                                                } else if (prefix === '000' || prefix === '111') {
                                                    isValid = false;
                                                    errorMessage = 'Invalid phone prefix.';
                                                } else if (prefix.startsWith('0') || prefix.startsWith('1')) {
                                                    isValid = false;
                                                    errorMessage = 'Phone prefix cannot start with 0 or 1.';
                                                } else if (['411', '911', '811', '711', '611', '511', '311', '211', '011'].includes(prefix)) {
                                                    isValid = false;
                                                    errorMessage = 'Phone number contains a reserved service prefix.';
                                                } else if (lineNumber === '0000' || lineNumber === '1111') {
                                                    isValid = false;
                                                    errorMessage = 'Invalid phone line number.';
                                                } else {
                                                    // Comprehensive US area code validation
                                                    const validAreaCodes = [
                                                        '201', '202', '203', '205', '206', '207', '208', '209', '210', '212', '213', '214', '215', '216', '217', '218', '219', '224', '225', '228', '229',
                                                        '231', '234', '239', '240', '248', '251', '252', '253', '254', '256', '260', '262', '267', '269', '270', '272', '274', '276', '281', '283',
                                                        '301', '302', '303', '304', '305', '307', '308', '309', '310', '312', '313', '314', '315', '316', '317', '318', '319', '320', '321', '323',
                                                        '325', '330', '331', '334', '336', '337', '339', '340', '341', '346', '347', '351', '352', '360', '361', '364', '380', '385', '386', '401',
                                                        '402', '404', '405', '406', '407', '408', '409', '410', '412', '413', '414', '415', '417', '419', '423', '424', '425', '430', '432', '434',
                                                        '435', '440', '442', '443', '445', '447', '458', '463', '464', '469', '470', '475', '478', '479', '480', '484', '501', '502', '503', '504',
                                                        '505', '507', '508', '509', '510', '512', '513', '515', '516', '517', '518', '520', '530', '531', '534', '539', '540', '541', '551', '559',
                                                        '561', '562', '563', '564', '567', '570', '571', '572', '573', '574', '575', '580', '585', '586', '601', '602', '603', '605', '606', '607',
                                                        '608', '609', '610', '612', '614', '615', '616', '617', '618', '619', '620', '623', '626', '628', '629', '630', '631', '636', '641', '646',
                                                        '650', '651', '657', '660', '661', '662', '667', '669', '678', '681', '682', '684', '689', '701', '702', '703', '704', '706', '707', '708',
                                                        '712', '713', '714', '715', '716', '717', '718', '719', '720', '724', '725', '727', '731', '732', '734', '737', '740', '743', '747', '754',
                                                        '757', '760', '762', '763', '765', '769', '770', '772', '773', '774', '775', '779', '781', '785', '786', '787', '801', '802', '803', '804',
                                                        '805', '806', '808', '810', '812', '813', '814', '815', '816', '817', '818', '820', '828', '830', '831', '832', '843', '845', '847', '848',
                                                        '850', '854', '856', '857', '858', '859', '860', '862', '863', '864', '865', '870', '872', '878', '901', '903', '904', '906', '907', '908',
                                                        '909', '910', '912', '913', '914', '915', '916', '917', '918', '919', '920', '925', '928', '929', '930', '931', '934', '936', '937', '940',
                                                        '941', '947', '949', '951', '952', '954', '956', '959', '970', '971', '972', '973', '978', '979', '980', '984', '985', '989'
                                                    ];
                                                    
                                                    if (!validAreaCodes.includes(areaCode)) {
                                                        isValid = false;
                                                        errorMessage = 'Please enter a valid US area code.';
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    // Update field styling and error message
                                    if (isValid) {
                                        field.style.borderColor = value ? '#10b981' : '#e2e8f0';
                                        field.setAttribute('aria-invalid', 'false');
                                        field.removeAttribute('aria-describedby');
                                        errorDiv.style.display = 'none';
                                    } else {
                                        field.style.borderColor = '#dc2626';
                                        field.setAttribute('aria-invalid', 'true');
                                        field.setAttribute('aria-describedby', fieldId + '-error');
                                        errorDiv.textContent = errorMessage;
                                        errorDiv.setAttribute('aria-live', 'polite');
                                        errorDiv.setAttribute('aria-atomic', 'true');
                                        errorDiv.style.display = 'block';
                                    }
                                }

                                // Payment method selection function
                                function selectPaymentMethod(method) {
                                    console.log('🔄 Switching to payment method:', method);
                                    
                                    const creditCardSection = document.getElementById('credit-card-section');
                                    const alternativeSection = document.getElementById('alternative-payment-section');
                                    const compTypeSection = document.getElementById('comp-type-section');
                                    const instructionsP = document.getElementById('payment-instructions');
                                    
                                    // Update radio button selection
                                    document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                                        radio.checked = radio.value === method;
                                        // Update visual selection
                                        const label = radio.closest('label');
                                        if (radio.checked) {
                                            label.style.borderColor = '#10b981';
                                            label.style.backgroundColor = '#f0fdf4';
                                        } else {
                                            label.style.borderColor = '#e2e8f0';
                                            label.style.backgroundColor = 'white';
                                        }
                                    });
                                    
                                    // Verify the change took effect
                                    const checkedElement = document.querySelector('input[name="payment-method"]:checked');
                                    console.log('🔍 Payment method now checked:', checkedElement ? checkedElement.value : 'none');
                                    
                                    if (method === 'credit_card') {
                                        creditCardSection.style.display = 'block';
                                        alternativeSection.style.display = 'none';
                                        compTypeSection.style.display = 'none';
                                    } else if (method === 'comp') {
                                        creditCardSection.style.display = 'none';
                                        alternativeSection.style.display = 'block';
                                        compTypeSection.style.display = 'block';
                                        
                                        // Update instructions for comp
                                        instructionsP.textContent = 'Your complimentary appointment will be confirmed. Please select the comp type above. No payment required.';
                                    } else {
                                        creditCardSection.style.display = 'none';
                                        alternativeSection.style.display = 'block';
                                        compTypeSection.style.display = 'none';
                                        
                                        // Update instructions based on method
                                        if (method === 'cash') {
                                            instructionsP.textContent = 'Your booking will be confirmed. Please bring exact cash payment to your appointment. Receipt will be provided for Dr. reconciliation.';
                                        } else if (method === 'other') {
                                            instructionsP.textContent = 'Your booking will be confirmed. Venmo/CashApp payment details will be provided via SMS/email. Receipt will be provided for Dr. reconciliation.';
                                        }
                                    }
                                    
                                    // Update total price display based on payment method
                                    updateTotalPrice();
                                }

                                // New function to handle safe step transitions
                                async function transitionStep(hideElementId, showElementId) {
                                    return new Promise((resolve) => {
                                        // Validate elements exist
                                        const hideElement = document.getElementById(hideElementId);
                                        const showElement = document.getElementById(showElementId);
                                        
                                        if (!hideElement || !showElement) {
                                            console.error('Step transition failed: Missing elements', hideElementId, showElementId);
                                            resolve();
                                            return;
                                        }
                                        
                                        // Use faster transition to prevent delays
                                        hideElement.style.transition = 'opacity 0.15s ease-out';
                                        hideElement.style.opacity = '0';
                                        
                                        setTimeout(() => {
                                            hideElement.style.display = 'none';
                                            showElement.style.display = 'block';
                                            showElement.style.opacity = '0';
                                            showElement.style.transition = 'opacity 0.15s ease-in';
                                            
                                            // Allow browser to process DOM changes
                                            requestAnimationFrame(() => {
                                                showElement.style.opacity = '1';
                                                
                                                // Minimal settling time
                                                setTimeout(resolve, 50);
                                            });
                                        }, 150);
                                    });
                                }

                                // Optimized function to wait for frame stability
                                async function waitForFrameStability() {
                                    return new Promise((resolve) => {
                                        let frameStableCount = 0;
                                        let attempts = 0;
                                        const maxAttempts = 20; // Max 1 second wait
                                        
                                        const checkStability = () => {
                                            attempts++;
                                            try {
                                                // Test frame access by querying DOM
                                                const testElement = document.getElementById('payment-info');
                                                if (testElement && testElement.style.display !== 'none') {
                                                    frameStableCount++;
                                                    if (frameStableCount >= 2) { // Reduced from 3 to 2
                                                        resolve();
                                                        return;
                                                    }
                                                }
                                                
                                                if (attempts >= maxAttempts) {
                                                    console.warn('Frame stability timeout, proceeding anyway');
                                                    resolve();
                                                    return;
                                                }
                                                
                                                setTimeout(checkStability, 50);
                                            } catch (error) {
                                                console.warn('Frame stability check failed, proceeding...', error);
                                                resolve(); // Don't retry on error, just proceed
                                            }
                                        };
                                        checkStability();
                                    });
                                }

                                async function previousStep() {
                                    if (currentStep === 2) {
                                        await transitionStep('datetime-selection', 'service-selection');
                                        document.getElementById('prev-btn').style.display = 'none';
                                        currentStep = 1;
                                    } else if (currentStep === 3) {
                                        await transitionStep('contact-info', 'datetime-selection');
                                        currentStep = 2;
                                    } else if (currentStep === 4) {
                                        await transitionStep('payment-info', 'contact-info');
                                        currentStep = 3;
                                    } else if (currentStep === 5) {
                                        await transitionStep('booking-summary', 'payment-info');
                                        document.getElementById('next-btn').style.display = 'inline-block';
                                        currentStep = 4;
                                    }
                                }

                                function updateBookingSummary() {
                                    const date = document.getElementById('booking-date').value;
                                    const time = document.getElementById('booking-time').value;
                                    const name = document.getElementById('client-name').value;
                                    const email = document.getElementById('client-email').value;
                                    const phone = document.getElementById('client-phone').value;
                                    const location = document.getElementById('location-type').value;
                                    const notes = document.getElementById('session-notes').value;
                                    
                                    const serviceNames = {
                                        '60min': '60-Minute Reset',
                                        '90min': '90-Minute Integrative',
                                        '120min': '120-Minute Premium',
                                        'consultation': '30-Minute Consultation',
                                        'test': 'Payment System Test'
                                    };
                                    
                                    const locationNames = {
                                        'in_clinic': 'In Clinic',
                                        'mobile': 'Mobile Service (+$50)'
                                    };
                                    
                                    const formattedDate = new Date(date).toLocaleDateString('en-US', {
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    });
                                    
                                    // Get selected add-ons
                                    const selectedAddons = [];
                                    const addonCheckboxes = document.querySelectorAll('.addon-option input[type="checkbox"]:checked');
                                    addonCheckboxes.forEach(checkbox => {
                                        const addonLabel = checkbox.parentElement.querySelector('span').textContent;
                                        const addonPrice = checkbox.getAttribute('data-price');
                                        selectedAddons.push(`${addonLabel} (+$${addonPrice})`);
                                    });
                                    
                                    const addonsDisplay = selectedAddons.length > 0 
                                        ? `<strong>Add-ons:</strong> ${selectedAddons.join(', ')}<br>` 
                                        : '';

                                    const summary = `
                                        <strong>Service:</strong> ${serviceNames[selectedService]}<br>
                                        <strong>Date:</strong> ${formattedDate}<br>
                                        <strong>Time:</strong> ${document.getElementById('booking-time').selectedOptions[0]?.textContent || time}<br>
                                        <strong>Client:</strong> ${name}<br>
                                        <strong>Email:</strong> ${email}<br>
                                        <strong>Phone:</strong> ${phone}<br>
                                        <strong>Location:</strong> ${locationNames[location]}<br>
                                        ${addonsDisplay}
                                        ${notes ? '<strong>Notes:</strong> ' + notes + '<br>' : ''}
                                    `;
                                    
                                    document.getElementById('summary-content').innerHTML = summary;
                                    updateTotalPrice();
                                }

                                // Initialize Stripe
                                const stripe = Stripe('pk_test_51RRBjzFxOpfkAGId3DsG7kyXDLKUET2Ht5jvpxzxKlELzjgwkRctz4goXrNJ5TqfQqufJBhEDuBoxfoZhxlbkNdm00cqSQtKVN');
                                const elements = stripe.elements();
                                let cardElement = null;
                                let paymentProcessing = false;
                                let timeoutId = null;

                                // Initialize Stripe card element when payment step is shown
                                function initializeStripeElements() {
                                    if (!cardElement) {
                                        cardElement = elements.create('card', {
                                            style: {
                                                base: {
                                                    fontSize: '16px',
                                                    color: '#374151',
                                                    '::placeholder': { color: '#9ca3af' }
                                                }
                                            }
                                        });
                                        cardElement.mount('#stripe-card-element');
                                        
                                        cardElement.on('change', ({ error }) => {
                                            const displayError = document.getElementById('stripe-card-errors');
                                            if (error) {
                                                displayError.textContent = error.message;
                                            } else {
                                                displayError.textContent = '';
                                            }
                                        });
                                    }
                                }

                                // Enhanced Stripe initialization with frame validation
                                async function initializeStripeElementsSafely() {
                                    return new Promise((resolve, reject) => {
                                        try {
                                            // Validate frame is still attached
                                            const stripeContainer = document.getElementById('stripe-card-element');
                                            if (!stripeContainer) {
                                                reject(new Error('Stripe container not found - frame may be detached'));
                                                return;
                                            }
                                            
                                            // Check if already initialized and still mounted
                                            if (cardElement) {
                                                try {
                                                    // Test if element is still responsive
                                                    cardElement.focus();
                                                    console.log('Stripe Elements already initialized and responsive');
                                                    resolve();
                                                    return;
                                                } catch (error) {
                                                    console.warn('Existing Stripe element unresponsive, reinitializing...', error);
                                                    cardElement = null; // Reset for reinitialization
                                                }
                                            }
                                            
                                            // Initialize with minimal retry logic
                                            let retryCount = 0;
                                            const maxRetries = 1;
                                            
                                            const initializeWithRetry = () => {
                                                try {
                                                    if (!cardElement) {
                                                        cardElement = elements.create('card', {
                                                            style: {
                                                                base: {
                                                                    fontSize: '16px',
                                                                    color: '#374151',
                                                                    '::placeholder': { color: '#9ca3af' }
                                                                }
                                                            }
                                                        });
                                                        
                                                        // Mount with error handling
                                                        cardElement.mount('#stripe-card-element');
                                                        
                                                        cardElement.on('change', ({ error }) => {
                                                            const displayError = document.getElementById('stripe-card-errors');
                                                            if (displayError) {
                                                                if (error) {
                                                                    displayError.textContent = error.message;
                                                                } else {
                                                                    displayError.textContent = '';
                                                                }
                                                            }
                                                        });
                                                        
                                                        cardElement.on('ready', () => {
                                                            console.log('Stripe Elements successfully initialized');
                                                            resolve();
                                                        });
                                                        
                                                        cardElement.on('error', (error) => {
                                                            console.error('Stripe Elements error:', error);
                                                            if (retryCount < maxRetries) {
                                                                retryCount++;
                                                                console.log(`Retrying Stripe initialization (${retryCount}/${maxRetries})...`);
                                                                cardElement = null;
                                                                setTimeout(initializeWithRetry, 1000);
                                                            } else {
                                                                reject(error);
                                                            }
                                                        });
                                                        
                                                        // Timeout fallback (reduced)
                                                        setTimeout(() => {
                                                            console.log('Stripe Elements initialization timeout fallback');
                                                            resolve(); // Resolve even if not ready
                                                        }, 3000);
                                                    }
                                                } catch (error) {
                                                    console.error('Stripe initialization error:', error);
                                                    if (retryCount < maxRetries) {
                                                        retryCount++;
                                                        console.log(`Retrying Stripe initialization (${retryCount}/${maxRetries})...`);
                                                        setTimeout(initializeWithRetry, 1000);
                                                    } else {
                                                        reject(error);
                                                    }
                                                }
                                            };
                                            
                                            initializeWithRetry();
                                            
                                        } catch (error) {
                                            console.error('Fatal Stripe initialization error:', error);
                                            reject(error);
                                        }
                                    });
                                }

                                async function submitBooking() {
                                    if (paymentProcessing) return;
                                    paymentProcessing = true;
                                    
                                    const button = document.getElementById('confirm-booking-btn');
                                    const status = document.getElementById('booking-status');
                                    
                                    // Get selected payment method
                                    const paymentMethodElement = document.querySelector('input[name="payment-method"]:checked');
                                    const selectedPaymentMethod = paymentMethodElement ? paymentMethodElement.value : 'credit_card';
                                    console.log('🔍 Selected payment method:', selectedPaymentMethod);
                                    
                                    button.disabled = true;
                                    
                                    if (selectedPaymentMethod === 'credit_card') {
                                        button.textContent = 'Processing Payment...';
                                        status.textContent = 'Starting payment processing...';
                                    } else {
                                        button.textContent = 'Confirming Booking...';
                                        status.textContent = 'Confirming your booking...';
                                    }
                                    status.style.color = '#10b981';
                                    
                                    console.log('🎯 Payment started');
                                    
                                    // Different timeout handling based on payment method
                                    let warningTimeoutId, criticalTimeoutId, timeoutId;
                                    
                                    if (selectedPaymentMethod === 'credit_card') {
                                        // Credit card needs longer timeouts for Stripe processing
                                        warningTimeoutId = setTimeout(() => {
                                            if (paymentProcessing) {
                                                console.warn('⚠️ Payment taking longer than expected');
                                                status.textContent = '⚠️ Payment processing may take up to 30 seconds. Please wait...';
                                                status.style.color = '#f59e0b';
                                            }
                                        }, 10000);
                                        
                                        criticalTimeoutId = setTimeout(() => {
                                            if (paymentProcessing) {
                                                console.warn('🔄 Payment still processing after 20 seconds');
                                                status.textContent = '🔄 Still processing. This can take up to 30 seconds...';
                                                status.style.color = '#dc2626';
                                            }
                                        }, 20000);
                                        
                                        timeoutId = setTimeout(() => {
                                            if (paymentProcessing) {
                                                console.error('⏰ Payment timeout after 30 seconds');
                                                status.textContent = '❌ Payment timeout. Check your account and contact us if charged.';
                                                status.style.color = '#dc2626';
                                                button.disabled = false;
                                                button.textContent = 'Try Again';
                                                paymentProcessing = false;
                                                
                                                if (warningTimeoutId) clearTimeout(warningTimeoutId);
                                                if (criticalTimeoutId) clearTimeout(criticalTimeoutId);
                                            }
                                        }, 30000);
                                    } else {
                                        // Alternative payments should be much faster
                                        timeoutId = setTimeout(() => {
                                            if (paymentProcessing) {
                                                console.error('⏰ Booking timeout after 15 seconds');
                                                status.textContent = '❌ Booking timeout. Please try again.';
                                                status.style.color = '#dc2626';
                                                button.disabled = false;
                                                button.textContent = 'Try Again';
                                                paymentProcessing = false;
                                            }
                                        }, 15000);
                                    }
                                    
                                    try {
                                        // Calculate total price
                                        const totalPrice = updateTotalPrice();
                                        
                                        // Gather client info
                                        const clientInfo = {
                                            name: document.getElementById('client-name').value,
                                            email: document.getElementById('client-email').value,
                                            phone: document.getElementById('client-phone').value
                                        };
                                        
                                        let paymentIntentId = null;
                                        
                                        if (selectedPaymentMethod === 'credit_card') {
                                            // Credit card payment processing
                                            const finalAmount = Math.max(totalPrice, 1.00);
                                            console.log(`💰 Processing credit card payment for $${finalAmount}`);
                                            
                                            status.textContent = 'Creating payment intent...';
                                            
                                            // Create payment intent
                                            const paymentResponse = await fetch('/api/web-booking/create-payment-intent', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                    amount: finalAmount,
                                                    service_type: selectedService,
                                                    client_info: clientInfo
                                                })
                                            });
                                            
                                            if (!paymentResponse.ok) {
                                                throw new Error(`Payment setup failed: ${paymentResponse.status}`);
                                            }
                                            
                                            const paymentData = await paymentResponse.json();
                                            
                                            if (!paymentData.success) {
                                                throw new Error(paymentData.error || 'Payment intent creation failed');
                                            }
                                            
                                            console.log('💳 Payment intent created:', paymentData.paymentIntentId);
                                            status.textContent = 'Processing Stripe payment...';
                                            
                                            // Confirm payment with Stripe using Elements
                                            const { error: stripeError, paymentIntent } = await stripe.confirmCardPayment(
                                                paymentData.clientSecret,
                                                {
                                                    payment_method: {
                                                        card: cardElement,
                                                        billing_details: {
                                                            name: clientInfo.name,
                                                            email: clientInfo.email
                                                        }
                                                    }
                                                }
                                            );
                                            
                                            if (stripeError) {
                                                throw new Error(`Stripe payment failed: ${stripeError.message}`);
                                            }
                                            
                                            console.log('✅ Stripe payment success:', paymentIntent.id);
                                            status.textContent = 'Payment successful! Creating booking...';
                                            paymentIntentId = paymentIntent.id;
                                        } else {
                                            // Alternative payment methods (cash, other, comp)
                                            if (selectedPaymentMethod === 'comp') {
                                                console.log(`🎁 Processing comp booking - no payment required`);
                                                status.textContent = 'Processing complimentary booking...';
                                            } else {
                                                console.log(`💰 Processing ${selectedPaymentMethod} payment for $${totalPrice}`);
                                                status.textContent = 'Processing booking...';
                                            }
                                            // No payment intent needed for alternative methods
                                        }
                                        
                                        // Create booking with payment confirmation
                                        const appointmentDate = document.getElementById('booking-date').value;
                                        const appointmentTime = document.getElementById('booking-time').value;
                                        const scheduledDateTime = new Date(`${appointmentDate}T${appointmentTime}`).toISOString();
                                        
                                        // Collect selected add-ons
                                        const selectedAddons = [];
                                        const addonCheckboxes = document.querySelectorAll('.addon-option input[type="checkbox"]:checked');
                                        let totalAddonPrice = 0;
                                        
                                        addonCheckboxes.forEach(checkbox => {
                                            const addonName = checkbox.getAttribute('data-addon');
                                            const addonPrice = parseInt(checkbox.getAttribute('data-price'));
                                            selectedAddons.push({
                                                name: addonName,
                                                price: addonPrice
                                            });
                                            totalAddonPrice += addonPrice;
                                        });

                                        // Get session analytics data
                                        const sessionDurations = {
                                            '60min': 60,
                                            '90min': 90,
                                            '120min': 120,
                                            'consultation': 30,
                                            'test': 5
                                        };
                                        
                                        const sessionCategories = {
                                            '60min': 'therapeutic_massage',
                                            '90min': 'therapeutic_massage',
                                            '120min': 'therapeutic_massage',
                                            'consultation': 'consultation',
                                            'test': 'system_test'
                                        };

                                        // Check if this is a complimentary booking
                                        const selectedServiceOption = document.querySelector('.service-option.active');
                                        const isComplimentary = selectedServiceOption?.dataset.bookingType === 'complimentary';
                                        
                                        const bookingData = {
                                            service_type: selectedService,
                                            service_category: sessionCategories[selectedService],
                                            service_duration_minutes: sessionDurations[selectedService],
                                            practitioner_id: '060863f2-0623-4785-b01a-f1760cfb8d14',
                                            scheduled_date: scheduledDateTime,
                                            client_name: clientInfo.name,
                                            client_email: clientInfo.email,
                                            client_phone: clientInfo.phone,
                                            special_requests: document.getElementById('session-notes').value,
                                            create_account: false,
                                            booking_type: isComplimentary ? 'complimentary' : 'regular',
                                            payment_method: selectedPaymentMethod,
                                            comp_type: selectedPaymentMethod === 'comp' ? document.getElementById('comp-type').value : null,
                                            payment_intent_id: paymentIntentId,
                                            addons: selectedAddons,
                                            addon_total_price: totalAddonPrice,
                                            location_type: document.getElementById('location-type').value,
                                            amount: selectedPaymentMethod === 'comp' ? 0 : totalPrice,
                                            base_price: basePrices[selectedService],
                                            timestamp: new Date().toISOString(),
                                            // Analytics metadata
                                            analytics: {
                                                session_duration_seconds: Math.floor((new Date() - new Date(bookingAnalytics.session_start)) / 1000),
                                                device_type: /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
                                                browser: navigator.userAgent.match(/(firefox|msie|chrome|safari|trident)/i)?.[0] || 'unknown',
                                                booking_flow_version: 'v2_with_addons',
                                                total_addon_count: selectedAddons.length,
                                                has_special_requests: !!document.getElementById('session-notes').value
                                            }
                                        };
                                        
                                        console.log('📅 Booking API call start');
                                        
                                        // Retry logic for booking creation
                                        let bookingResult;
                                        let bookingRetries = 0;
                                        const maxBookingRetries = 3;
                                        
                                        while (bookingRetries < maxBookingRetries) {
                                            try {
                                                const bookingResponse = await fetch('/api/bookings', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(bookingData)
                                                });
                                                
                                                bookingResult = await bookingResponse.json();
                                                
                                                if (bookingResult.success || bookingResponse.status !== 500) {
                                                    break; // Success or non-retryable error
                                                }
                                                
                                                throw new Error(bookingResult.error || 'Booking failed');
                                                
                                            } catch (bookingError) {
                                                bookingRetries++;
                                                console.warn(`Booking attempt ${bookingRetries} failed:`, bookingError.message);
                                                
                                                if (bookingRetries >= maxBookingRetries) {
                                                    throw new Error(`Booking failed after ${maxBookingRetries} attempts: ${bookingError.message}`);
                                                }
                                                
                                                // Wait before retry with exponential backoff
                                                const retryDelay = Math.min(1000 * Math.pow(2, bookingRetries - 1), 3000);
                                                status.textContent = `Booking attempt failed. Retrying in ${retryDelay/1000} seconds... (${bookingRetries}/${maxBookingRetries})`;
                                                await new Promise(resolve => setTimeout(resolve, retryDelay));
                                                
                                                if (selectedPaymentMethod === 'credit_card') {
                                                    status.textContent = 'Payment successful! Creating booking...';
                                                } else {
                                                    status.textContent = 'Retrying booking creation...';
                                                }
                                            }
                                        }
                                        
                                        console.log('📋 Booking API result:', bookingResult.success ? 'SUCCESS' : 'FAILED');
                                        
                                        if (bookingResult.success) {
                                            console.log('🎉 Booking created, confirming payment...');
                                            status.textContent = 'Finalizing booking and sending confirmations...';
                                            
                                            // Confirm payment to trigger notifications
                                            try {
                                                const confirmPayload = {
                                                    payment_method: selectedPaymentMethod
                                                };
                                                
                                                // Only include payment_intent_id for credit card payments
                                                if (paymentIntentId) {
                                                    confirmPayload.payment_intent_id = paymentIntentId;
                                                }
                                                
                                                const confirmResponse = await fetch(`/api/web-booking/confirm-payment/${bookingResult.data.session.id}`, {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(confirmPayload)
                                                });
                                                
                                                const confirmResult = await confirmResponse.json();
                                                
                                                if (confirmResult.success) {
                                                    console.log('💫 Payment confirmed and notifications sent');
                                                    status.textContent = '✅ Booking confirmed! Check your email and SMS for details.';
                                                    status.style.color = '#10b981';
                                                    button.textContent = 'Booking Complete';
                                                    
                                                    // Show detailed success message
                                                    setTimeout(() => {
                                                        const receipt = confirmResult.data.receipt_number;
                                                        const compType = document.getElementById('comp-type').value;
                                                        const compMessage = selectedPaymentMethod === 'comp' ? `\nComp Type: ${compType}\nNo payment required` : '';
                                                        alert(`🎉 Booking Complete!\n\nConfirmation: ${receipt}\nEmail & SMS confirmations sent${compMessage}\n\nPage will refresh in 3 seconds...`);
                                                    }, 500);
                                                    
                                                    // Reset form after 3 seconds
                                                    setTimeout(() => location.reload(), 3000);
                                                } else {
                                                    console.warn('Payment confirmation failed but booking exists:', confirmResult.error);
                                                    status.textContent = '⚠️ Booking created but confirmation failed. We will contact you shortly.';
                                                    status.style.color = '#f59e0b';
                                                    button.textContent = 'Booking Created';
                                                    setTimeout(() => location.reload(), 5000);
                                                }
                                            } catch (confirmError) {
                                                console.error('Payment confirmation error:', confirmError);
                                                status.textContent = '⚠️ Booking created. Email confirmations may be delayed.';
                                                status.style.color = '#f59e0b';
                                                button.textContent = 'Booking Created';
                                                setTimeout(() => location.reload(), 5000);
                                            }
                                        } else {
                                            throw new Error(bookingResult.error || 'Booking creation failed');
                                        }
                                        
                                    } catch (error) {
                                        console.error('💥 Booking flow error:', error);
                                        status.textContent = `❌ ${error.message || 'Booking failed. Please try again or call us.'}`;
                                        status.style.color = '#dc2626';
                                        button.disabled = false;
                                        button.textContent = 'Try Again';
                                    } finally {
                                        // Clear all timeouts
                                        if (timeoutId) clearTimeout(timeoutId);
                                        if (warningTimeoutId) clearTimeout(warningTimeoutId);
                                        if (criticalTimeoutId) clearTimeout(criticalTimeoutId);
                                        paymentProcessing = false;
                                    }
                                }
                            </script>

                            <!-- Step 1: Service Selection -->
                            <!-- Real Functional Booking Form -->
                            <div id="service-selection" class="mb-xl">
                                <!-- Introductory Pricing Banner -->
                                <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 1rem; border-radius: 12px; text-align: center; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">🎉 Limited Time: Introductory Pricing - Save 25%!</div>
                                    <div style="font-size: 0.875rem; opacity: 0.9;">*Regular pricing begins August 2025 (Updated)</div>
                                </div>

                                <h3 class="subsection-heading text-center mb-lg" style="color: var(--sage-700);">Step 1: Choose Your Session</h3>
                                
                                <div class="service-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    <div class="service-option" data-service-type="60min_massage" data-service="60min" data-price="$135" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; position: relative;">
                                        <div style="background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-bottom: 0.5rem;">⚡ FIRST-TIMER SPECIAL</div>
                                        <h4 style="color: var(--sage-700); margin-bottom: 0.25rem; font-size: 1.1rem; font-weight: 700;">60-Min Pain Relief</h4>
                                        <div style="font-size: 2rem; font-weight: 800; color: #10b981; margin-bottom: 0.25rem;">$135</div>
                                        <p style="color: var(--sage-700); font-size: 1rem; margin: 0; font-weight: 600;">Stop pain at the source • Perfect starting point</p>
                                    </div>
                                    
                                    <div class="service-option featured" data-service-type="90min_massage" data-service="90min" data-price="$180" style="border: 3px solid #10b981; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); position: relative; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.25);">
                                        <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #dc2626, #ef4444); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);">🔥 98% CHOOSE THIS</div>
                                        <h4 style="color: var(--sage-700); margin-bottom: 0.25rem; margin-top: 1rem; font-size: 1.2rem; font-weight: 700;">90-Min Full Reset</h4>
                                        <div style="font-size: 2.2rem; font-weight: 800; color: #10b981; margin-bottom: 0.25rem;">$180</div>
                                        <p style="color: var(--sage-700); font-size: 1rem; margin: 0; font-weight: 600;">Fix chronic pain • Root cause healing</p>
                                    </div>
                                    
                                    <div class="service-option" data-service-type="120min_massage" data-service="120min" data-price="$225" style="border: 2px solid #f59e0b; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s;">
                                        <div style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-bottom: 0.5rem;">👑 PREMIUM</div>
                                        <h4 style="color: var(--sage-700); margin-bottom: 0.25rem; font-size: 1.1rem; font-weight: 700;">120-Min Total Transform</h4>
                                        <div style="font-size: 2rem; font-weight: 800; color: #f59e0b; margin-bottom: 0.25rem;">$225</div>
                                        <p style="color: var(--sage-700); font-size: 1rem; margin: 0; font-weight: 600;">Complex conditions • Full transformation</p>
                                    </div>
                                    
                                    <div class="service-option" data-service-type="consultation" data-service="consultation" data-price="$60" style="border: 2px solid #64748b; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s;">
                                        <div style="background: #64748b; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-bottom: 0.5rem;">💬 NOT SURE?</div>
                                        <h4 style="color: var(--sage-700); margin-bottom: 0.25rem; font-size: 1.1rem; font-weight: 700;">30-Min Consultation</h4>
                                        <div style="font-size: 2rem; font-weight: 800; color: #64748b; margin-bottom: 0.25rem;">$60</div>
                                        <p style="color: var(--sage-700); font-size: 1rem; margin: 0; font-weight: 600;">Get assessment • Plan your treatment</p>
                                    </div>
                                    
                                    <div class="service-option" data-service-type="test" data-service="test" data-price="$1.00" style="border: 2px solid #ef4444; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s;">
                                        <div style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-bottom: 0.5rem;">🧪 SYSTEM TEST</div>
                                        <h4 style="color: var(--sage-700); margin-bottom: 0.25rem; font-size: 1.1rem; font-weight: 700;">Payment Test</h4>
                                        <div style="font-size: 2rem; font-weight: 800; color: #ef4444; margin-bottom: 0.25rem;">$1.00</div>
                                        <p style="color: var(--sage-700); font-size: 1rem; margin: 0; font-weight: 600;">Test booking system • Minimal charge</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Date & Time Selection -->
                            <div id="datetime-selection" style="display: none;" class="mb-xl">
                                <h3 class="subsection-heading text-center mb-lg" style="color: var(--sage-700);">Step 2: Choose Date & Time</h3>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label for="booking-date" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--sage-700);">Preferred Date</label>
                                        <input type="date" id="booking-date" 
                                               style="width: 100%; min-height: 44px; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" 
                                               required 
                                               aria-describedby="date-availability-info"
                                               aria-label="Preferred appointment date">
                                        <div id="date-availability-info" 
                                             style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--sage-600); display: none;"
                                             role="status"
                                             aria-live="polite"
                                             aria-atomic="true">
                                            <div id="closed-date-warning" 
                                                 style="color: #dc2626; display: none;"
                                                 role="alert"
                                                 aria-live="assertive">
                                                ⚠️ Selected date is closed. Please choose an available date.
                                            </div>
                                            <div id="available-days-hint" 
                                                 style="color: var(--sage-600);"
                                                 role="note">
                                                📅 Available days: Monday (10 AM - 6 PM), Wednesday (12 PM - 8 PM), Friday (10 AM - 6 PM), Saturday (11 AM - 7 PM)
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="booking-time" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--sage-700);">Available Times</label>
                                        <select id="booking-time" 
                                                style="width: 100%; min-height: 44px; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" 
                                                required 
                                                disabled
                                                aria-label="Available appointment times">
                                            <option value="">Select date first...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="time-loading" style="display: none; text-align: center; margin-top: 1rem; color: var(--sage-600);">
                                    Loading available times...
                                </div>

                                <!-- Add-Ons Section -->
                                <div style="margin-top: 2rem; padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 12px; background: linear-gradient(145deg, #fafdf9, #f0f4f0);">
                                    <h4 style="color: var(--sage-700); margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700; text-align: center;">✨ Enhance Your Experience</h4>
                                    
                                    <div class="addon-options" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                                        <div class="addon-option" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s; background: white;">
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="checkbox" id="aromatherapy-addon" data-addon="aromatherapy" data-price="20" style="margin-right: 0.75rem; width: 18px; height: 18px; accent-color: #10b981;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-weight: 600; color: var(--sage-700);">🌿 Aromatherapy</span>
                                                        <span style="font-weight: 700; color: #10b981; font-size: 1.1rem;">+$20</span>
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: var(--sage-600); margin-top: 0.25rem;">Custom essential oil blend for your session</div>
                                                    <div style="font-size: 0.85rem; color: var(--sage-500); margin-top: 0.25rem; font-style: italic;">Most popular • Relaxation enhancement</div>
                                                </div>
                                            </label>
                                        </div>

                                        <div class="addon-option" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s; background: white;">
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="checkbox" id="hot-stones-addon" data-addon="hot_stones" data-price="25" style="margin-right: 0.75rem; width: 18px; height: 18px; accent-color: #10b981;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-weight: 600; color: var(--sage-700);">🪨 Hot Stone Therapy</span>
                                                        <span style="font-weight: 700; color: #10b981; font-size: 1.1rem;">+$25</span>
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: var(--sage-600); margin-top: 0.25rem;">Heated basalt stones for deep muscle relaxation</div>
                                                    <div style="font-size: 0.85rem; color: var(--sage-500); margin-top: 0.25rem; font-style: italic;">Premium upgrade • Deep heat therapy</div>
                                                </div>
                                            </label>
                                        </div>

                                        <div class="addon-option" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s; background: white;">
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="checkbox" id="coldstone-facial-addon" data-addon="coldstone_facial" data-price="30" style="margin-right: 0.75rem; width: 18px; height: 18px; accent-color: #10b981;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-weight: 600; color: var(--sage-700);">❄️ Cold Stone Facial Massage</span>
                                                        <span style="font-weight: 700; color: #10b981; font-size: 1.1rem;">+$30</span>
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: var(--sage-600); margin-top: 0.25rem;">Cooling stones for facial tension and rejuvenation</div>
                                                    <div style="font-size: 0.85rem; color: var(--sage-500); margin-top: 0.25rem; font-style: italic;">Luxury enhancement • Anti-inflammatory</div>
                                                </div>
                                            </label>
                                        </div>

                                        <div class="addon-option" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s; background: white;">
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="checkbox" id="peppermint-scalp-addon" data-addon="peppermint_scalp" data-price="18" style="margin-right: 0.75rem; width: 18px; height: 18px; accent-color: #10b981;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-weight: 600; color: var(--sage-700);">🌱 Peppermint Scalp Massage</span>
                                                        <span style="font-weight: 700; color: #10b981; font-size: 1.1rem;">+$18</span>
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: var(--sage-600); margin-top: 0.25rem;">Invigorating scalp treatment with peppermint oil</div>
                                                    <div style="font-size: 0.85rem; color: var(--sage-500); margin-top: 0.25rem; font-style: italic;">Refreshing • Stress relief</div>
                                                </div>
                                            </label>
                                        </div>

                                        <div class="addon-option" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s; background: white;">
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="checkbox" id="heated-mask-addon" data-addon="heated_mask" data-price="22" style="margin-right: 0.75rem; width: 18px; height: 18px; accent-color: #10b981;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-weight: 600; color: var(--sage-700);">🧴 Heated Hydrated Hand/Foot Mask</span>
                                                        <span style="font-weight: 700; color: #10b981; font-size: 1.1rem;">+$22</span>
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: var(--sage-600); margin-top: 0.25rem;">Moisturizing heated mask treatment</div>
                                                    <div style="font-size: 0.85rem; color: var(--sage-500); margin-top: 0.25rem; font-style: italic;">Nourishing • Hydration therapy</div>
                                                </div>
                                            </label>
                                        </div>

                                        <div class="addon-option" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s; background: white;">
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="checkbox" id="reflexology-addon" data-addon="reflexology" data-price="28" style="margin-right: 0.75rem; width: 18px; height: 18px; accent-color: #10b981;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-weight: 600; color: var(--sage-700);">👣 Reflexology</span>
                                                        <span style="font-weight: 700; color: #10b981; font-size: 1.1rem;">+$28</span>
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: var(--sage-600); margin-top: 0.25rem;">Therapeutic foot pressure point massage</div>
                                                    <div style="font-size: 0.85rem; color: var(--sage-500); margin-top: 0.25rem; font-style: italic;">Healing • Whole body wellness</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Contact Information -->
                            <div id="contact-info" style="display: none;" class="mb-xl">
                                <h3 class="subsection-heading text-center mb-lg" style="color: var(--sage-700);">Step 3: Your Information</h3>
                                
                                <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                                    <div>
                                        <label for="client-name" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--sage-700);">Full Name *</label>
                                        <input type="text" id="client-name" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" required placeholder="First Last (minimum 3 characters each)" data-validate="name">
                                        <div id="client-name-error" style="color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; display: none;"></div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <label for="client-email" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--sage-700);">Email Address *</label>
                                            <input type="email" id="client-email" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" required placeholder="name@domain.com" data-validate="email">
                                            <div id="client-email-error" style="color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; display: none;"></div>
                                        </div>
                                        
                                        <div>
                                            <label for="client-phone" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--sage-700);">Phone Number *</label>
                                            <input type="tel" id="client-phone" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" required placeholder="(940) 555-0123" data-validate="phone">
                                            <div id="client-phone-error" style="color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; display: none;"></div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="location-type" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--sage-700);">Session Location</label>
                                        <select id="location-type" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" data-update="price">
                                            <option value="in_clinic">In Clinic</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="session-notes" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--sage-700);">Special Requests or Health Notes</label>
                                        <textarea id="session-notes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical;" placeholder="Any health conditions, areas of focus, or special requests..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Payment Information -->
                            <div id="payment-info" style="display: none;" class="mb-xl">
                                <h3 class="subsection-heading text-center mb-lg" style="color: var(--sage-700);">Step 4: Payment Information</h3>
                                
                                <div style="background: var(--sage-50); border: 2px solid var(--sage-200); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                    <h4 style="color: var(--sage-700); margin-bottom: 1rem;">Payment Details</h4>
                                    
                                    <div style="border-top: 1px solid var(--sage-300); margin-top: 1rem; padding-top: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                            <span style="font-weight: 600; color: var(--sage-700);">Total Amount:</span>
                                            <span id="payment-total-price" style="font-size: 1.25rem; font-weight: 700; color: #10b981;">$0</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Payment Method Selection -->
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 0.75rem; color: var(--sage-700);">Payment Method *</label>
                                        <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem;">
                                            <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white;">
                                                <input type="radio" name="payment-method" value="credit_card" id="payment-method-card" style="margin-right: 0.75rem;" checked>
                                                <div>
                                                    <div style="font-weight: 600; color: var(--sage-700);">💳 Credit Card</div>
                                                    <div style="font-size: 0.875rem; color: var(--sage-500);">Secure online payment via Stripe</div>
                                                </div>
                                            </label>
                                            
                                            <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white;">
                                                <input type="radio" name="payment-method" value="cash" id="payment-method-cash" style="margin-right: 0.75rem;">
                                                <div>
                                                    <div style="font-weight: 600; color: var(--sage-700);">💵 Cash</div>
                                                    <div style="font-size: 0.875rem; color: var(--sage-500);">Pay in cash at your appointment</div>
                                                </div>
                                            </label>
                                            
                                            <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white;">
                                                <input type="radio" name="payment-method" value="other" id="payment-method-other" style="margin-right: 0.75rem;">
                                                <div>
                                                    <div style="font-weight: 600; color: var(--sage-700);">📱 Other (Venmo, CashApp)</div>
                                                    <div style="font-size: 0.875rem; color: var(--sage-500);">Alternative payment methods - arranged with practitioner</div>
                                                </div>
                                            </label>
                                            
                                            <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white;">
                                                <input type="radio" name="payment-method" value="comp" id="payment-method-comp" style="margin-right: 0.75rem;">
                                                <div>
                                                    <div style="font-weight: 600; color: var(--sage-700);">🎁 Comp</div>
                                                    <div style="font-size: 0.875rem; color: var(--sage-500);">Complimentary appointment</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Comp Type Selection (shown only when comp selected) -->
                                    <div id="comp-type-section" style="display: none; margin-bottom: 1.5rem;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 0.75rem; color: var(--sage-700);">Comp Type *</label>
                                        <select name="comp-type" id="comp-type" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: var(--sage-700); font-size: 1rem;">
                                            <option value="">Select comp type...</option>
                                            <option value="family">Family</option>
                                            <option value="friends">Friends</option>
                                            <option value="veterans">Veterans</option>
                                            <option value="elderly">Elderly</option>
                                            <option value="practitioner">Practitioner Comp</option>
                                            <option value="referral">Referral Comp</option>
                                            <option value="staff">Staff Comp</option>
                                            <option value="marketing">Marketing/Promotional</option>
                                            <option value="charity">Charity/Community Service</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Credit Card Details (shown only when credit card selected) -->
                                    <div id="credit-card-section" style="display: block;">
                                        <div id="stripe-card-element" style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; margin: 1rem 0;">
                                            <!-- Stripe card element --></div>
                                        <div id="stripe-card-errors" style="color: #dc2626; margin-top: 0.5rem; font-size: 0.875rem;"></div>
                                        
                                        <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                                            <p style="color: #1e40af; margin: 0; font-size: 0.875rem;">
                                                🔒 Your payment is secure and encrypted. We use Stripe for payment processing.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Alternative Payment Instructions -->
                                    <div id="alternative-payment-section" style="display: none;">
                                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem;">
                                            <p style="color: #92400e; margin: 0; font-size: 0.875rem; font-weight: 600;">
                                                ℹ️ Payment Instructions
                                            </p>
                                            <p id="payment-instructions" style="color: #92400e; margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                                Your booking will be confirmed and payment details will be provided via SMS/email.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 5: Booking Summary & Confirmation -->
                            <div id="booking-summary" style="display: none;" class="mb-xl">
                                <h3 class="subsection-heading text-center mb-lg" style="color: var(--sage-700);">Step 5: Confirm Your Booking</h3>
                                
                                <div style="background: var(--sage-50); border: 2px solid var(--sage-200); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                    <h4 style="color: var(--sage-700); margin-bottom: 1rem;">Booking Summary</h4>
                                    
                                    <div id="summary-content" style="color: var(--sage-600); line-height: 1.6;">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                    
                                    <div style="border-top: 1px solid var(--sage-300); margin-top: 1rem; padding-top: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 600; color: var(--sage-700);">Total Amount:</span>
                                            <span id="total-price" style="font-size: 1.25rem; font-weight: 700; color: #10b981;">$0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="text-align: center;">
                                    <button id="confirm-booking-btn" style="background: #10b981; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; min-width: 200px;">
                                        Confirm Booking
                                    </button>
                                    
                                    <div id="booking-status" style="margin-top: 1rem; font-weight: 600;"></div>
                                </div>
                            </div>

                            <!-- Navigation Buttons -->
                            <div class="booking-navigation" style="display: flex; justify-content: space-between; margin-top: 2rem;">
                                <button id="prev-btn" style="background: #64748b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: none;">
                                    ← Previous
                                </button>
                                
                                <button id="next-btn" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; margin-left: auto; display: none;">
                                    Next →
                                </button>
                            </div>

                            <p class="booking-subtitle body-text text-center mt-xl" style="color: var(--warm-gray-600);">
                                Complete your booking in just 5 simple steps
                            </p>

                        </div>
                    </div>
                </div>
            
            <div class="section-divider"></div>
        </section>

        <!-- Elegant Contact Section -->
        <section id="contact" class="luxury-section">
            <div class="mobile-container">
                <div class="text-center mb-xl">
                    <h2 class="section-heading">Connect With Us</h2>
                </div>
                
                <div class="contact-card">
                    <!-- Contact Methods -->
                    <div class="space-y-md mb-xl">
                        <div class="contact-method">
                            <div class="contact-icon">📞</div>
                            <a href="tel:9402685999" class="contact-link">940.268.5999</a>
                        </div>
                        
                        <div class="contact-method">
                            <div class="contact-icon">✉</div>
                            <a href="mailto:info@ittheal.com" class="contact-link">info@ittheal.com</a>
                        </div>
                    </div>
                    
                    <!-- Treatment Hours -->
                    <div class="hours-section">
                        <h3 class="hours-title">Treatment Hours</h3>
                        <div class="space-y-sm">
                            <div class="hours-item">
                                <span class="hours-day">Monday</span>
                                <span class="hours-time">10am - 6pm</span>
                            </div>
                            <div class="hours-item">
                                <span class="hours-day">Wednesday</span>
                                <span class="hours-time">12pm - 8pm</span>
                            </div>
                            <div class="hours-item">
                                <span class="hours-day">Friday</span>
                                <span class="hours-time">10am - 6pm</span>
                            </div>
                            <div class="hours-item">
                                <span class="hours-day">Saturday</span>
                                <span class="hours-time">11am - 7pm</span>
                            </div>
                            <div class="hours-item">
                                <span class="hours-day">Tue, Thu, Sun</span>
                                <span class="hours-time color-warm-gray-500">Closed</span>
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--warm-gray-500); margin-top: 1rem; font-style: italic; text-align: center;">
                            Hours & days of operation may change
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Luxury Footer -->
        <footer class="luxury-section" style="background: var(--warm-gray-800); color: var(--warm-gray-100); padding: var(--space-2xl) 0;">
            <div class="mobile-container">
                <div class="text-center">
                    <h3 class="header-title" style="color: var(--warm-gray-100); margin-bottom: var(--space-sm);">
                        Integrative Touch Therapies, LLC
                    </h3>
                    <p class="subtitle" style="color: var(--sage-300); margin-bottom: var(--space-sm);">
                        Dr. Shiffer, CST, LMT
                    </p>
                    <p class="body-text" style="color: var(--warm-gray-300); margin-bottom: var(--space-xl);">
                        Movement Specialist
                    </p>
                    
                    <div class="space-y-md" style="margin-bottom: var(--space-xl);">
                        <div>
                            <a href="tel:9402685999" 
                               style="color: var(--warm-gray-100); text-decoration: none; font-size: 1.125rem;">
                                📞 940.268.5999
                            </a>
                        </div>
                        <div>
                            <a href="mailto:info@ittheal.com" 
                               style="color: var(--warm-gray-100); text-decoration: none; font-size: 1.125rem;">
                                📧 info@ittheal.com
                            </a>
                        </div>
                        <div style="color: var(--warm-gray-100); font-size: 1.125rem;">
                            🌐 ittheal.com
                        </div>
                    </div>
                    
                    <div class="border-warm-gray-700 pt-lg mt-xl">
                        <p style="color: var(--warm-gray-400); font-size: 0.9375rem;">
                            © 2024 Integrative Touch Therapies, LLC. All rights reserved.
                        </p>
                    </div>
                </div>
            </div>
        </footer>
    </main>

    <!-- Luxury JavaScript -->
    <!-- Shared Frontend Utilities -->
    <script type="module" src="./js/shared-integration.js?v=20250708-tip-001"></script>
    <script defer src="./js/booking-shared-migration.js?v=20250708-tip-001"></script>
    
    <script defer src="./js/luxury-mobile.js?v=20250607-luxury-001"></script>
    <script src="./js/pricing-booking.js?v=20250708-tip-001"></script>
    <script defer src="./js/native-booking.js?v=20250616-native-009"></script>
    <script defer src="./js/error-handler.js?v=20250606-002"></script>
    
    <!-- Debug script to verify functions are loaded -->
    <script>
        // Immediate inline implementation for test buttons
        console.log('Debug: Creating inline handleBooking function');
        
        // Define handleBooking inline if it doesn't exist
        window.handleBooking = function(duration) {
            console.log('Inline handleBooking called with:', duration);
            
            // Convert duration to session type and call native booking
            const sessionType = duration + 'min_massage';
            if (typeof window.handleNativeBooking === 'function') {
                console.log('Calling handleNativeBooking with:', sessionType);
                window.handleNativeBooking(sessionType);
            } else {
                console.error('handleNativeBooking not available, retrying...');
                setTimeout(() => {
                    if (typeof window.handleNativeBooking === 'function') {
                        window.handleNativeBooking(sessionType);
                    } else {
                        alert('Booking system is loading. Please try again in a moment.');
                    }
                }, 1000);
            }
        };
        
        console.log('Debug: Inline handleBooking function created');
        console.log('typeof handleBooking:', typeof handleBooking);
    </script>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            // Booking functions check disabled temporarily
        });
    </script>
    
    <!-- Mobile Menu Toggle -->
    <script>
        // Remove all JS - using inline onclick only
    </script>
    
    <!-- Header is now sticky via CSS only - no JavaScript needed -->

    <!-- Event Listener Setup -->
    <script>
        function setupEventListeners() {
            // Mobile menu now uses inline onclick handlers
            
            // Booking form buttons
            const loadTimeSlotsBtn = document.getElementById('load-time-slots-btn');
            const confirmBookingBtn = document.getElementById('confirm-booking-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            if (loadTimeSlotsBtn) {
                loadTimeSlotsBtn.addEventListener('click', function() {
                    // Use the new booking availability system
                    if (window.BookingAvailability) {
                        window.BookingAvailability.refresh();
                    }
                });
            }
            if (confirmBookingBtn) {
                confirmBookingBtn.addEventListener('click', submitBooking);
            }
            if (prevBtn) {
                prevBtn.addEventListener('click', previousStep);
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', nextStep);
            }

            // Service selection
            const serviceOptions = document.querySelectorAll('.service-option');
            serviceOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const service = this.getAttribute('data-service');
                    const price = this.getAttribute('data-price');
                    if (service && price) {
                        selectService(service, price);
                    }
                });
            });

            // Payment method radio buttons
            const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    if (this.checked) {
                        selectPaymentMethod(this.value);
                    }
                });
            });

            // Add-on checkboxes
            const addonCheckboxes = document.querySelectorAll('.addon-option input[type="checkbox"]');
            addonCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateTotalPrice();
                    // Update visual feedback
                    const addonOption = this.closest('.addon-option');
                    const addonName = this.getAttribute('data-addon');
                    const addonPrice = this.getAttribute('data-price');
                    
                    if (this.checked) {
                        addonOption.style.borderColor = '#10b981';
                        addonOption.style.background = '#f0fdf4';
                        
                        // Track add-on selection
                        console.log('📊 Analytics: Add-on Selected', {
                            addon_name: addonName,
                            addon_price: addonPrice,
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        addonOption.style.borderColor = '#e2e8f0';
                        addonOption.style.background = 'white';
                        
                        // Track add-on deselection
                        console.log('📊 Analytics: Add-on Deselected', {
                            addon_name: addonName,
                            addon_price: addonPrice,
                            timestamp: new Date().toISOString()
                        });
                    }
                });
            });

            // Date change event listener - removed old loadTimeSlots call
            // The booking-availability.js module now handles date changes

            // Time selection event listener for real-time availability validation
            const bookingTime = document.getElementById('booking-time');
            if (bookingTime) {
                bookingTime.addEventListener('change', function() {
                    const selectedTime = this.value;
                    const selectedDate = document.getElementById('booking-date')?.value;
                    
                    if (selectedTime && selectedDate) {
                        // Trigger real-time availability check
                        validateTimeSelection(selectedDate, selectedTime);
                        
                        // Announce selection to screen readers
                        const announcement = document.createElement('div');
                        announcement.setAttribute('role', 'status');
                        announcement.setAttribute('aria-live', 'polite');
                        announcement.setAttribute('aria-atomic', 'true');
                        announcement.className = 'sr-only';
                        announcement.textContent = `Selected appointment time: ${selectedTime} on ${selectedDate}`;
                        document.body.appendChild(announcement);
                        
                        // Remove announcement after 3 seconds
                        setTimeout(() => {
                            announcement.remove();
                        }, 3000);
                    }
                });
            }

            // Location type change event listener
            const locationType = document.getElementById('location-type');
            if (locationType) {
                locationType.addEventListener('change', updateTotalPrice);
            }
        }
    </script>

    <!-- Booking Availability Handler -->
    <script src="./js/booking-availability.js?v=20250708-booking-001"></script>
    
    <!-- Smooth scrolling for anchor links -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add smooth scrolling to all links with hashes
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const target = document.querySelector(targetId);
                    if (target) {
                        // Get header height for offset
                        const header = document.querySelector('.itt-header');
                        const headerHeight = header ? header.offsetHeight : 160;
                        
                        // Special offset for modalities sections
                        let extraOffset = 20;
                        if (targetId === '#six-modalities' || targetId === '#healing-modalities-grid') {
                            // Different offset for mobile vs desktop
                            const isMobile = window.innerWidth <= 768;
                            extraOffset = isMobile ? 100 : 150; // Smaller offset since we're targeting the grid directly
                        }
                        
                        // Scroll to target with offset
                        const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - headerHeight - extraOffset;
                        
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                        
                        // Close mobile menu if open
                        if (mobileMenuOpen) {
                            closeMobileMenu();
                        }
                    }
                });
            });

            // Setup event listeners for buttons
            setupEventListeners();
            
            // Setup event listeners for data attributes (WCAG compliance)
            // Handle hover effects
            document.querySelectorAll('[data-hover="true"]').forEach(element => {
                element.addEventListener('mouseenter', function() {
                    this.style.background = '#324036';
                    this.style.color = 'white';
                });
                element.addEventListener('mouseleave', function() {
                    this.style.background = '#f5f5f2';
                    this.style.color = '#324036';
                });
            });
            
            // Handle form validation
            document.querySelectorAll('[data-validate]').forEach(field => {
                field.addEventListener('input', function() {
                    const validateType = this.getAttribute('data-validate');
                    validateFieldRealTime(this.id, validateType);
                });
            });
            
            // Handle price updates
            document.querySelectorAll('[data-update="price"]').forEach(element => {
                element.addEventListener('change', function() {
                    updateTotalPrice();
                });
            });
        });
    </script>
</body>
</html>